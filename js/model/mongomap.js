"use strict";
/**
 * Functionality to map the "flat" categories model to a nested document
 *
 * @file
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeMongoMap = exports.unwindsForNonterminalArrays = exports.getShortProjectedName = exports.isNonObjectPath = exports.makeCanonicPropertyName = exports.getFirstSegment = exports.makeCategoryPath = exports.getFirstMemberByPath = exports.getMemberByPath = exports.collectMemberByPath = exports.findEschemaPropForCategory = exports.collectCategories = void 0;
//import * as intf from 'constants';
const debug = require("debugf");
var debuglog = debug('mongomap');
const process = require("process");
const _ = require("lodash");
/**
 * the model path, may be controlled via environment variable
 */
var envModelPath = process.env["ABOT_MODELPATH"] || "node_modules/abot_testmodel/testmodel";
function traverseExecutingContext(obj, context) {
    _.forIn(obj, function (val, key) {
        // console.log(key + " -> " + val + " ");
        context.visit(obj, key, val);
        if (_.isArray(val)) {
            context.enterArray(key, val);
            val.forEach(function (el) {
                if (_.isObject(el)) {
                    traverseExecutingContext(el, context);
                }
            });
            context.leaveArray(key, val);
            // console.log('leaving array key' + key  + " " + JSON.stringify(val));
        }
        else if (_.isObject(val)) {
            //  if( _.isArray(val) && _.isObject(val)) {
            //&&      console.log('ABCXASDFS');
            //  };
            //   console.log('is also object' + JSON.stringify(val));
            context.enterObject(key, val);
            traverseExecutingContext(val, context);
            context.leaveObject(key, val);
        }
    });
}
function collectCategories(eSchemaProps) {
    var oContext = {
        res: {},
        plainPath: [],
        currentPath: [],
        enterObject: function (key, val) {
            this.currentPath.push(key);
            this.plainPath.push(key);
        },
        visit: function (obj, key, val) {
            if (key === '_m_category') {
                var lastSeg = this.plainPath[this.plainPath.length - 1];
                this.res[val] = {
                    paths: this.currentPath.slice(),
                    fullpath: this.plainPath.join('.'),
                    shortName: lastSeg
                };
            }
        },
        leaveObject: function (key, val) {
            this.currentPath.pop();
            this.plainPath.pop();
        },
        enterArray: function (key, val) {
            this.enterObject(key, val);
            this.currentPath.push('[]');
        },
        leaveArray: function (key, val) {
            this.leaveObject(key, val);
            this.currentPath.pop();
        }
    };
    traverseExecutingContext(eSchemaProps, oContext);
    return oContext.res;
}
exports.collectCategories = collectCategories;
function findEschemaPropForCategory(eSchemaProps, category) {
    var prop = findEschemaPropForCategoryInt(eSchemaProps, category);
    if (prop._m_category != category) {
        throw new Error("Mismatch between category and prop " + category + " " + JSON.stringify(prop));
    }
    return prop;
}
exports.findEschemaPropForCategory = findEschemaPropForCategory;
function unwrapArrayOne(a) {
    if (_.isArray(a) && a.length == 1) {
        return a[0];
    }
    return a;
}
function findEschemaPropForCategoryInt(eSchemaProps, category) {
    var propName = makeCanonicPropertyName(category);
    var direct = eSchemaProps[propName];
    // todo: there is an ambiguity between 
    //  "category_synonyms" : [{ "type" : "String" , "_m_category":"category_synonyms"}]
    // and 
    //  "category_synonyms" : { "type" : ["String"] , "_m_category":"category_synonyms"}
    // see e.g. sendertyp , see also the spurious Items type for standort
    if (direct) {
        return unwrapArrayOne(direct);
    }
    var res = { r: undefined };
    var oContext = {
        enterObject: function (key, val) {
        },
        visit: function (obj, key, val) {
            if ((_.isObject(val) || _.isArray(val)) && propName == key) {
                if (res.r) {
                    throw new Error("Duplicate property " + propName + " " + JSON.stringify(res.r) + " now " + JSON.stringify(val));
                }
                debuglog('found prop ' + JSON.stringify(res.r) + ' looking for ' + category + ' in ' + JSON.stringify(eSchemaProps));
                res.r = unwrapArrayOne(val);
            }
        },
        leaveObject: function (key, val) {
        },
        enterArray: function (key, val) {
        },
        leaveArray: function (key, val) {
        }
    };
    traverseExecutingContext(eSchemaProps, oContext);
    return res.r;
}
/**
 * return an array(may be empty) containing
 * @param rec
 * @param paths
 */
function collectMemberByPath(rec, paths) {
    if (rec == undefined) {
        return [];
    }
    if (!_.isArray(paths)) {
        debugger;
        console.log(' not an array' + paths);
    }
    return paths.reduce((prev, segment, index) => {
        debuglog(() => `at index ${index} segment ${segment} on ${JSON.stringify(prev)}`);
        if (prev === undefined || prev === null) {
            return undefined;
        }
        if (segment !== "[]") {
            var next = prev.map(o => o[segment]).filter(p => (p !== undefined));
            return _.flatten(next);
        }
        else {
            return prev;
        }
    }, [rec]).filter(a => a != undefined); // should we filter by undefined or null
}
exports.collectMemberByPath = collectMemberByPath;
/**
 * Given a record and a paths expression, return
 * the value (string or array) which represents this path
 *
 * This method has a slight ambiguity w.r.t. single or multivalued results.
 *   e.g. abc : [{hij : 2}]       will return [2], not 2.
 *
 *
 * Note that a trailing array is not expanded,
 * @param rec
 * @param paths
 */
function getMemberByPath(rec, paths) {
    var root = rec;
    var res = paths.reduce((prev, segment, index) => {
        debuglog(() => `at index ${index} segment ${segment} on ${JSON.stringify(prev)}`);
        if (prev === undefined || prev === null) {
            return undefined;
        }
        if (segment !== "[]") {
            debuglog(' segment ' + index + ' ' + segment + ' ');
            if (_.isArray(prev)) {
                var ru = prev.map(o => o[segment]).filter(o => !!o);
                debuglog(' here result segment ' + index + ' category ' + segment + ' result ' + JSON.stringify(ru));
                return ru.length ? ru : undefined;
            }
            else {
                debuglog(' no array ' + index + ' category ' + segment + ' result ' + JSON.stringify(prev[segment]));
                return prev[segment];
            }
        }
        else {
            if (index === (paths.length - 1)) {
                return prev;
            }
            if (_.isArray(prev)) {
                return prev;
            }
            else {
                return prev;
            }
        }
    }, rec);
    debuglog(() => ` here result ` + res);
    return res;
}
exports.getMemberByPath = getMemberByPath;
function getFirstMemberByPath(rec, paths) {
    var res = getMemberByPath(rec, paths);
    if (res && _.isArray(res)) {
        return res[0];
    }
    return res;
}
exports.getFirstMemberByPath = getFirstMemberByPath;
function constructPath(paths, len) {
    return paths.slice(0, len).filter(seg => seg !== '[]').join('.');
}
/**
 * return a category
 * @param mongoMap
 * @param cat a category
 * @return the constructed path
 */
function makeCategoryPath(mongoMap, category) {
    return mongoMap[category].fullpath;
}
exports.makeCategoryPath = makeCategoryPath;
/**
 * Given a segment path, return the
 * @param paths
 */
function getFirstSegment(paths) {
    if (paths[0] === '[]' || paths.length === 0) {
        throw new Error('did not expect a full array');
    }
    return paths[0];
}
exports.getFirstSegment = getFirstSegment;
function makeCanonicPropertyName(category) {
    // no lowercasing!
    return category.replace(/[^a-zA-Z0-9]/g, '_');
}
exports.makeCanonicPropertyName = makeCanonicPropertyName;
function isNonObjectPath(mongoMap, category) {
    return mongoMap[category].fullpath.indexOf(".") < 0;
}
exports.isNonObjectPath = isNonObjectPath;
function getShortProjectedName(mongoMap, category) {
    if (isNonObjectPath(mongoMap, category)) {
        return mongoMap[category].fullpath;
    }
    return makeCanonicPropertyName(category);
}
exports.getShortProjectedName = getShortProjectedName;
function unwindsForNonterminalArrays(mongoMap) {
    var paths = Object.keys(mongoMap).map(key => mongoMap[key].paths);
    var res = [];
    var seenAccess = {};
    return paths.reduce((prev, path) => {
        var prefix = '';
        return path.reduce((prev, segment, index) => {
            if (path.length - 1 !== index) {
                // last segment never of interest, even if []
                if (segment === '[]') {
                    var expandPath = constructPath(path, index);
                    if (!seenAccess[expandPath]) {
                        seenAccess[expandPath] = true;
                        prev.push({
                            $unwind: {
                                path: expandPath,
                                preserveNullAndEmptyArrays: true
                            }
                        });
                    }
                }
                return prev;
            }
            return prev;
        }, prev);
    }, res);
}
exports.unwindsForNonterminalArrays = unwindsForNonterminalArrays;
function makeMongoMap(oDoc, eSchema) {
    var oMongoMap = {};
    debuglog(() => 'creating mongomap for ' + JSON.stringify(eSchema.modelname, undefined, 2) + ' and ' + oDoc.modelname);
    debuglog(() => 'creating mongomap for doc ' + JSON.stringify(oDoc, undefined, 2));
    debuglog(() => 'colleting from eSchema.props' + JSON.stringify(eSchema.props, undefined, 2));
    var res = collectCategories(eSchema.props);
    oDoc._categories.forEach(cat => {
        // cross check
        if (!res[cat.category]) {
            console.log('here present keys' + Object.keys(res).sort().join("; "));
            console.log(`category ${cat.category} is not in eSchema`); // + JSON.stringify(eSchema,undefined,2)
            console.log(`document has ` + oDoc._categories.map(cat => cat.category).join('; '));
            //process.exit(-1);
            console.log(`category "${cat.category}" is not in eSchema for ${oDoc.modelname} + ${eSchema.modelname} : `
                + "=====Schema:\n" + JSON.stringify(eSchema, undefined, 2).substring(0, 400)
                + "\n========oDoc: \n" + JSON.stringify(oDoc, undefined, 2).substring(0, 400));
            process.exit(-1);
            throw new Error(`category ${cat.category} is not in eSchema for ${oDoc.modelname} + ${eSchema.modelname} : `
                + JSON.stringify(eSchema, undefined, 2).substring(0, 200)
                + "\n=========== " + JSON.stringify(oDoc, undefined, 2).substring(0, 400));
        }
    });
    return res;
}
exports.makeMongoMap = makeMongoMap;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb25nb21hcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7R0FJRzs7O0FBR0gsb0NBQW9DO0FBQ3BDLGdDQUFnQztBQUVoQyxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7QUFhakMsbUNBQW1DO0FBQ25DLDRCQUE0QjtBQUc1Qjs7R0FFRztBQUNILElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsSUFBSSx1Q0FBdUMsQ0FBQztBQUc1RixTQUFTLHdCQUF3QixDQUFDLEdBQUcsRUFBRSxPQUFPO0lBQzFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLFVBQVUsR0FBRyxFQUFFLEdBQUc7UUFDM0IseUNBQXlDO1FBQ3pDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM1QixJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDaEIsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUMsR0FBRyxDQUFDLENBQUM7WUFDNUIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFTLEVBQUU7Z0JBQ25CLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRTtvQkFDaEIsd0JBQXdCLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2lCQUN6QztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUMsR0FBRyxDQUFDLENBQUM7WUFDN0IsdUVBQXVFO1NBQ3pFO2FBQ0ksSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3hCLDRDQUE0QztZQUM1QyxtQ0FBbUM7WUFDbkMsTUFBTTtZQUNQLHlEQUF5RDtZQUN0RCxPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FB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QUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMvRixtQkFBbUI7WUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsR0FBRyxDQUFDLFFBQVEsMkJBQTJCLElBQUksQ0FBQyxTQUFTLE1BQU0sT0FBTyxDQUFDLFNBQVMsS0FBSztrQkFDdkcsZ0JBQWdCLEdBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUMsU0FBUyxFQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUMsR0FBRyxDQUFDO2tCQUN0RSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBQyxTQUFTLEVBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzVFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqQixNQUFNLElBQUksS0FBSyxDQUFDLFlBQVksR0FBRyxDQUFDLFFBQVEsMEJBQTBCLElBQUksQ0FBQyxTQUFTLE1BQU0sT0FBTyxDQUFDLFNBQVMsS0FBSztrQkFDMUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUMsU0FBUyxFQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUMsR0FBRyxDQUFDO2tCQUNwRCxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBQyxTQUFTLEVBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQzNFO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDSCxPQUFPLEdBQUcsQ0FBQztBQUNmLENBQUM7QUF2QkQsb0NBdUJDIiwiZmlsZSI6Im1vZGVsL21vbmdvbWFwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEZ1bmN0aW9uYWxpdHkgdG8gbWFwIHRoZSBcImZsYXRcIiBjYXRlZ29yaWVzIG1vZGVsIHRvIGEgbmVzdGVkIGRvY3VtZW50XHJcbiAqXHJcbiAqIEBmaWxlXHJcbiAqL1xyXG5cclxuXHJcbi8vaW1wb3J0ICogYXMgaW50ZiBmcm9tICdjb25zdGFudHMnO1xyXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Z2YnO1xyXG5cclxudmFyIGRlYnVnbG9nID0gZGVidWcoJ21vbmdvbWFwJyk7XHJcblxyXG5pbXBvcnQgKiBhcyBJU2NoZW1hIGZyb20gJy4uL21vZGVsbG9hZC9zY2hlbWFsb2FkJztcclxuLy9jb25zdCBsb2FkbG9nID0gbG9nZ2VyLmxvZ2dlcignbW9kZWxsb2FkJywgJycpO1xyXG5cclxuaW1wb3J0ICogIGFzIElNYXRjaCBmcm9tICcuLi9tYXRjaC9pZm1hdGNoJztcclxuaW1wb3J0ICogYXMgSW5wdXRGaWx0ZXJSdWxlcyBmcm9tICcuLi9tYXRjaC9ydWxlJztcclxuLy9pbXBvcnQgKiBhcyBUb29scyBmcm9tICcuLi9tYXRjaC90b29scyc7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0ICogYXMgTWV0YSBmcm9tICcuL21ldGEnO1xyXG5pbXBvcnQgKiBhcyBVdGlscyBmcm9tICdhYm90X3V0aWxzJztcclxuaW1wb3J0ICogYXMgQ2lyY3VsYXJTZXIgZnJvbSAnYWJvdF91dGlscyc7XHJcbmltcG9ydCAqIGFzIERpc3RhbmNlIGZyb20gJ2Fib3Rfc3RyaW5nZGlzdCc7XHJcbmltcG9ydCAqIGFzIHByb2Nlc3MgZnJvbSAncHJvY2Vzcyc7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuXHJcbnR5cGUgQ2F0TW9uZ29NYXAgPSBJTWF0Y2guQ2F0TW9uZ29NYXA7XHJcbi8qKlxyXG4gKiB0aGUgbW9kZWwgcGF0aCwgbWF5IGJlIGNvbnRyb2xsZWQgdmlhIGVudmlyb25tZW50IHZhcmlhYmxlXHJcbiAqL1xyXG52YXIgZW52TW9kZWxQYXRoID0gcHJvY2Vzcy5lbnZbXCJBQk9UX01PREVMUEFUSFwiXSB8fCBcIm5vZGVfbW9kdWxlcy9hYm90X3Rlc3Rtb2RlbC90ZXN0bW9kZWxcIjtcclxuXHJcblxyXG5mdW5jdGlvbiB0cmF2ZXJzZUV4ZWN1dGluZ0NvbnRleHQob2JqLCBjb250ZXh0KSB7XHJcbiAgICBfLmZvckluKG9iaiwgZnVuY3Rpb24gKHZhbCwga2V5KSB7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coa2V5ICsgXCIgLT4gXCIgKyB2YWwgKyBcIiBcIik7XHJcbiAgICAgICAgY29udGV4dC52aXNpdChvYmosa2V5LCB2YWwpO1xyXG4gICAgICAgIGlmIChfLmlzQXJyYXkodmFsKSkge1xyXG4gICAgICAgICAgICBjb250ZXh0LmVudGVyQXJyYXkoa2V5LHZhbCk7XHJcbiAgICAgICAgICAgIHZhbC5mb3JFYWNoKGZ1bmN0aW9uKGVsKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoXy5pc09iamVjdChlbCkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0cmF2ZXJzZUV4ZWN1dGluZ0NvbnRleHQoZWwsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgY29udGV4dC5sZWF2ZUFycmF5KGtleSx2YWwpO1xyXG4gICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdsZWF2aW5nIGFycmF5IGtleScgKyBrZXkgICsgXCIgXCIgKyBKU09OLnN0cmluZ2lmeSh2YWwpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoXy5pc09iamVjdCh2YWwpKSB7XHJcbiAgICAgICAgICAvLyAgaWYoIF8uaXNBcnJheSh2YWwpICYmIF8uaXNPYmplY3QodmFsKSkge1xyXG4gICAgICAgICAgLy8mJiAgICAgIGNvbnNvbGUubG9nKCdBQkNYQVNERlMnKTtcclxuICAgICAgICAgIC8vICB9O1xyXG4gICAgICAgICAvLyAgIGNvbnNvbGUubG9nKCdpcyBhbHNvIG9iamVjdCcgKyBKU09OLnN0cmluZ2lmeSh2YWwpKTtcclxuICAgICAgICAgICAgY29udGV4dC5lbnRlck9iamVjdChrZXksIHZhbCk7XHJcbiAgICAgICAgICAgIHRyYXZlcnNlRXhlY3V0aW5nQ29udGV4dCh2YWwsY29udGV4dCk7XHJcbiAgICAgICAgICAgIGNvbnRleHQubGVhdmVPYmplY3Qoa2V5LHZhbCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjb2xsZWN0Q2F0ZWdvcmllcyhlU2NoZW1hUHJvcHMgOiBhbnkpIHtcclxuICAgIHZhciBvQ29udGV4dCA9IHtcclxuICAgICAgICByZXMgOiB7fSBhcyBDYXRNb25nb01hcCxcclxuICAgICAgICBwbGFpblBhdGggOiBbXSxcclxuICAgICAgICBjdXJyZW50UGF0aCA6IFtdLFxyXG4gICAgICAgIGVudGVyT2JqZWN0IDogZnVuY3Rpb24oa2V5OiBzdHJpbmcsIHZhbDogYW55KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFBhdGgucHVzaChrZXkpO1xyXG4gICAgICAgICAgICB0aGlzLnBsYWluUGF0aC5wdXNoKGtleSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICB2aXNpdDogZnVuY3Rpb24ob2JqIDogYW55LCBrZXk6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICAgICAgaWYoa2V5ID09PSAnX21fY2F0ZWdvcnknKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbGFzdFNlZyA9IHRoaXMucGxhaW5QYXRoW3RoaXMucGxhaW5QYXRoLmxlbmd0aC0xXTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVzW3ZhbF0gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGF0aHMgOiB0aGlzLmN1cnJlbnRQYXRoLnNsaWNlKCksXHJcbiAgICAgICAgICAgICAgICAgICAgZnVsbHBhdGggOiB0aGlzLnBsYWluUGF0aC5qb2luKCcuJyksXHJcbiAgICAgICAgICAgICAgICAgICAgc2hvcnROYW1lIDogbGFzdFNlZ1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBsZWF2ZU9iamVjdCA6IGZ1bmN0aW9uKGtleTogc3RyaW5nLCB2YWw6IGFueSkge1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRQYXRoLnBvcCgpO1xyXG4gICAgICAgICAgICB0aGlzLnBsYWluUGF0aC5wb3AoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVudGVyQXJyYXkgOiBmdW5jdGlvbihrZXkgOiBzdHJpbmcsIHZhbDogYW55KSB7XHJcbiAgICAgICAgICAgIHRoaXMuZW50ZXJPYmplY3Qoa2V5LCB2YWwpO1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRQYXRoLnB1c2goJ1tdJyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBsZWF2ZUFycmF5IDogZnVuY3Rpb24oa2V5IDogc3RyaW5nLCB2YWw6IGFueSkge1xyXG4gICAgICAgICAgICB0aGlzLmxlYXZlT2JqZWN0KGtleSwgdmFsKTtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50UGF0aC5wb3AoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICB0cmF2ZXJzZUV4ZWN1dGluZ0NvbnRleHQoZVNjaGVtYVByb3BzLCBvQ29udGV4dCApO1xyXG4gICAgcmV0dXJuIG9Db250ZXh0LnJlcztcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kRXNjaGVtYVByb3BGb3JDYXRlZ29yeShlU2NoZW1hUHJvcHMgOiBhbnksIGNhdGVnb3J5IDogc3RyaW5nKSA6IGFueSB7XHJcbiAgICB2YXIgcHJvcCA9IGZpbmRFc2NoZW1hUHJvcEZvckNhdGVnb3J5SW50KGVTY2hlbWFQcm9wcyxjYXRlZ29yeSk7XHJcbiAgICBpZiAoIHByb3AuX21fY2F0ZWdvcnkgIT0gY2F0ZWdvcnkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNaXNtYXRjaCBiZXR3ZWVuIGNhdGVnb3J5IGFuZCBwcm9wIFwiICsgY2F0ZWdvcnkgKyBcIiBcIiArIEpTT04uc3RyaW5naWZ5KHByb3ApKTtcclxuICAgIH1cclxuICAgIHJldHVybiBwcm9wO1xyXG59XHJcblxyXG5mdW5jdGlvbiB1bndyYXBBcnJheU9uZShhOiBhbnkpIDogYW55IHtcclxuICAgIGlmICggXy5pc0FycmF5KGEpICYmIGEubGVuZ3RoID09IDEgKSB7XHJcbiAgICAgICAgcmV0dXJuIGFbMF07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYTtcclxufVxyXG5cclxuZnVuY3Rpb24gZmluZEVzY2hlbWFQcm9wRm9yQ2F0ZWdvcnlJbnQoZVNjaGVtYVByb3BzIDogYW55LCBjYXRlZ29yeSA6IHN0cmluZykgOiBhbnkge1xyXG4gICAgdmFyIHByb3BOYW1lID0gbWFrZUNhbm9uaWNQcm9wZXJ0eU5hbWUoY2F0ZWdvcnkpO1xyXG4gICAgdmFyIGRpcmVjdCA9IGVTY2hlbWFQcm9wc1twcm9wTmFtZV07XHJcbiAgICAvLyB0b2RvOiB0aGVyZSBpcyBhbiBhbWJpZ3VpdHkgYmV0d2VlbiBcclxuICAgIC8vICBcImNhdGVnb3J5X3N5bm9ueW1zXCIgOiBbeyBcInR5cGVcIiA6IFwiU3RyaW5nXCIgLCBcIl9tX2NhdGVnb3J5XCI6XCJjYXRlZ29yeV9zeW5vbnltc1wifV1cclxuICAgIC8vIGFuZCBcclxuICAgIC8vICBcImNhdGVnb3J5X3N5bm9ueW1zXCIgOiB7IFwidHlwZVwiIDogW1wiU3RyaW5nXCJdICwgXCJfbV9jYXRlZ29yeVwiOlwiY2F0ZWdvcnlfc3lub255bXNcIn1cclxuICAgIC8vIHNlZSBlLmcuIHNlbmRlcnR5cCAsIHNlZSBhbHNvIHRoZSBzcHVyaW91cyBJdGVtcyB0eXBlIGZvciBzdGFuZG9ydFxyXG4gICAgaWYgKCBkaXJlY3QgKSB7XHJcbiAgICAgICByZXR1cm4gdW53cmFwQXJyYXlPbmUoZGlyZWN0KTtcclxuICAgIH1cclxuICAgIHZhciByZXMgPSB7IHI6IHVuZGVmaW5lZCB9O1xyXG4gICAgdmFyIG9Db250ZXh0ID0ge1xyXG4gICAgICAgIGVudGVyT2JqZWN0IDogZnVuY3Rpb24oa2V5OiBzdHJpbmcsIHZhbDogYW55KSB7XHJcbiAgICAgICAgfSxcclxuICAgICAgICB2aXNpdDogZnVuY3Rpb24ob2JqIDogYW55LCBrZXk6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICAgICAgaWYgKCAoXy5pc09iamVjdCh2YWwpIHx8IF8uaXNBcnJheSh2YWwpKSAmJiBwcm9wTmFtZSA9PSBrZXkpIHtcclxuICAgICAgICAgICAgICAgIGlmIChyZXMuciApICB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRHVwbGljYXRlIHByb3BlcnR5IFwiICsgcHJvcE5hbWUgKyBcIiBcIiArIEpTT04uc3RyaW5naWZ5KHJlcy5yKSArIFwiIG5vdyBcIiArIEpTT04uc3RyaW5naWZ5KHZhbCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZGVidWdsb2coJ2ZvdW5kIHByb3AgJyArIEpTT04uc3RyaW5naWZ5KHJlcy5yKSArICcgbG9va2luZyBmb3IgJyArIGNhdGVnb3J5ICsgJyBpbiAnICsgSlNPTi5zdHJpbmdpZnkoZVNjaGVtYVByb3BzKSk7XHJcbiAgICAgICAgICAgICAgICByZXMuciA9ICB1bndyYXBBcnJheU9uZSh2YWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBsZWF2ZU9iamVjdCA6IGZ1bmN0aW9uKGtleTogc3RyaW5nLCB2YWw6IGFueSkge1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW50ZXJBcnJheSA6IGZ1bmN0aW9uKGtleSA6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGxlYXZlQXJyYXkgOiBmdW5jdGlvbihrZXkgOiBzdHJpbmcsIHZhbDogYW55KSB7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgdHJhdmVyc2VFeGVjdXRpbmdDb250ZXh0KGVTY2hlbWFQcm9wcywgb0NvbnRleHQgKTtcclxuICAgIHJldHVybiByZXMucjtcclxufVxyXG5cclxuLyoqXHJcbiAqIHJldHVybiBhbiBhcnJheShtYXkgYmUgZW1wdHkpIGNvbnRhaW5pbmcgXHJcbiAqIEBwYXJhbSByZWMgXHJcbiAqIEBwYXJhbSBwYXRocyBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBjb2xsZWN0TWVtYmVyQnlQYXRoKHJlYyA6IGFueSwgcGF0aHMgOiBzdHJpbmdbXSkgOiBhbnlbXSB7XHJcbiAgICBpZiAoIHJlYyA9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbiAgICBpZiggIV8uaXNBcnJheShwYXRocykpIHtcclxuICAgICAgICBkZWJ1Z2dlcjtcclxuICAgICAgICBjb25zb2xlLmxvZygnIG5vdCBhbiBhcnJheScgKyBwYXRocyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcGF0aHMucmVkdWNlKCAocHJldiwgc2VnbWVudCxpbmRleCkgPT4ge1xyXG4gICAgICAgIGRlYnVnbG9nKCgpPT4gYGF0IGluZGV4ICR7aW5kZXh9IHNlZ21lbnQgJHtzZWdtZW50fSBvbiAke0pTT04uc3RyaW5naWZ5KHByZXYpfWApO1xyXG5cclxuICAgICAgICBpZihwcmV2ID09PSB1bmRlZmluZWQgfHwgcHJldiA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZihzZWdtZW50ICE9PSBcIltdXCIpIHtcclxuICAgICAgICAgICAgdmFyIG5leHQgPSBwcmV2Lm1hcCggbyA9PiBvW3NlZ21lbnRdICkuZmlsdGVyKHAgPT4gKHAgIT09IHVuZGVmaW5lZCkgKTtcclxuICAgICAgICAgICAgcmV0dXJuIF8uZmxhdHRlbiggbmV4dCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHByZXY7XHJcbiAgICAgICAgfVxyXG4gICAgfSwgW3JlY10pLmZpbHRlciggYSA9PiBhICE9IHVuZGVmaW5lZCk7IC8vIHNob3VsZCB3ZSBmaWx0ZXIgYnkgdW5kZWZpbmVkIG9yIG51bGxcclxufVxyXG4vKipcclxuICogR2l2ZW4gYSByZWNvcmQgYW5kIGEgcGF0aHMgZXhwcmVzc2lvbiwgcmV0dXJuXHJcbiAqIHRoZSB2YWx1ZSAoc3RyaW5nIG9yIGFycmF5KSB3aGljaCByZXByZXNlbnRzIHRoaXMgcGF0aFxyXG4gKlxyXG4gKiBUaGlzIG1ldGhvZCBoYXMgYSBzbGlnaHQgYW1iaWd1aXR5IHcuci50LiBzaW5nbGUgb3IgbXVsdGl2YWx1ZWQgcmVzdWx0cy4gXHJcbiAqICAgZS5nLiBhYmMgOiBbe2hpaiA6IDJ9XSAgICAgICB3aWxsIHJldHVybiBbMl0sIG5vdCAyLlxyXG4gKlxyXG4gKlxyXG4gKiBOb3RlIHRoYXQgYSB0cmFpbGluZyBhcnJheSBpcyBub3QgZXhwYW5kZWQsXHJcbiAqIEBwYXJhbSByZWNcclxuICogQHBhcmFtIHBhdGhzXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWVtYmVyQnlQYXRoKHJlYyA6IGFueSwgcGF0aHM6IHN0cmluZ1tdKSAgOiBhbnkge1xyXG4gICAgdmFyIHJvb3QgPSByZWM7XHJcbiAgICB2YXIgcmVzID0gcGF0aHMucmVkdWNlKCAocHJldiwgc2VnbWVudCxpbmRleCkgPT4ge1xyXG4gICAgICAgIGRlYnVnbG9nKCgpPT4gYGF0IGluZGV4ICR7aW5kZXh9IHNlZ21lbnQgJHtzZWdtZW50fSBvbiAke0pTT04uc3RyaW5naWZ5KHByZXYpfWApO1xyXG4gICAgICAgIGlmKHByZXYgPT09IHVuZGVmaW5lZCB8fCBwcmV2ID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmKHNlZ21lbnQgIT09IFwiW11cIikge1xyXG4gICAgICAgICAgICBkZWJ1Z2xvZygnIHNlZ21lbnQgJyArIGluZGV4ICsgJyAnICsgc2VnbWVudCArICcgJyk7XHJcbiAgICAgICAgICAgIGlmICggXy5pc0FycmF5KHByZXYpICkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJ1ID0gIHByZXYubWFwKCBvID0+IG9bc2VnbWVudF0pLmZpbHRlciggbyA9PiAhIW8gKTtcclxuICAgICAgICAgICAgICAgIGRlYnVnbG9nKCcgaGVyZSByZXN1bHQgc2VnbWVudCAnICsgaW5kZXggKyAnIGNhdGVnb3J5ICcgKyBzZWdtZW50ICsgJyByZXN1bHQgJyArIEpTT04uc3RyaW5naWZ5KHJ1KSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcnUubGVuZ3RoID8gcnUgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZygnIG5vIGFycmF5ICcgKyBpbmRleCArICcgY2F0ZWdvcnkgJyArIHNlZ21lbnQgKyAnIHJlc3VsdCAnICsgSlNPTi5zdHJpbmdpZnkocHJldltzZWdtZW50XSkpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHByZXZbc2VnbWVudF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZihpbmRleCA9PT0gKHBhdGhzLmxlbmd0aCAtIDEpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihfLmlzQXJyYXkocHJldikpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHByZXY7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9LCByZWMpO1xyXG4gICAgZGVidWdsb2coKCk9PiBgIGhlcmUgcmVzdWx0IGAgKyByZXMpO1xyXG4gICAgcmV0dXJuIHJlcztcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEZpcnN0TWVtYmVyQnlQYXRoKHJlYyA6IGFueSwgcGF0aHM6IHN0cmluZ1tdKSAgOiBhbnkge1xyXG4gICAgdmFyIHJlcyA9IGdldE1lbWJlckJ5UGF0aChyZWMsIHBhdGhzKTtcclxuICAgIGlmICggcmVzICYmIF8uaXNBcnJheShyZXMpKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlc1swXTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbnN0cnVjdFBhdGgocGF0aHMgOiBzdHJpbmcgW10sIGxlbiA6IG51bWJlcikge1xyXG4gICAgcmV0dXJuIHBhdGhzLnNsaWNlKDAsIGxlbikuZmlsdGVyKHNlZyA9PiBzZWcgIT09ICdbXScpLmpvaW4oJy4nKTtcclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiByZXR1cm4gYSBjYXRlZ29yeVxyXG4gKiBAcGFyYW0gbW9uZ29NYXBcclxuICogQHBhcmFtIGNhdCBhIGNhdGVnb3J5XHJcbiAqIEByZXR1cm4gdGhlIGNvbnN0cnVjdGVkIHBhdGhcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBtYWtlQ2F0ZWdvcnlQYXRoKG1vbmdvTWFwOiBJTWF0Y2guQ2F0TW9uZ29NYXAgLCBjYXRlZ29yeSA6IHN0cmluZykgOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIG1vbmdvTWFwW2NhdGVnb3J5XS5mdWxscGF0aDtcclxufVxyXG5cclxuLyoqXHJcbiAqIEdpdmVuIGEgc2VnbWVudCBwYXRoLCByZXR1cm4gdGhlXHJcbiAqIEBwYXJhbSBwYXRoc1xyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEZpcnN0U2VnbWVudChwYXRocyA6IHN0cmluZ1tdICkgOiBzdHJpbmcge1xyXG4gICAgaWYocGF0aHNbMF0gPT09ICdbXScgIHx8IHBhdGhzLmxlbmd0aCA9PT0gMCkgIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2RpZCBub3QgZXhwZWN0IGEgZnVsbCBhcnJheScpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBhdGhzWzBdO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWFrZUNhbm9uaWNQcm9wZXJ0eU5hbWUoY2F0ZWdvcnkgOiBzdHJpbmcgKSA6IHN0cmluZyB7XHJcbiAgICAvLyBubyBsb3dlcmNhc2luZyFcclxuICAgIHJldHVybiBjYXRlZ29yeS5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywnXycpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNOb25PYmplY3RQYXRoKG1vbmdvTWFwIDogSU1hdGNoLkNhdE1vbmdvTWFwLCBjYXRlZ29yeSA6IHN0cmluZykgOiBib29sZWFuIHtcclxuICAgIHJldHVybiBtb25nb01hcFtjYXRlZ29yeV0uZnVsbHBhdGguaW5kZXhPZihcIi5cIikgPCAwO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2hvcnRQcm9qZWN0ZWROYW1lKG1vbmdvTWFwOiBJTWF0Y2guQ2F0TW9uZ29NYXAsIGNhdGVnb3J5IDogc3RyaW5nKSA6IHN0cmluZyB7XHJcbiAgICBpZihpc05vbk9iamVjdFBhdGgobW9uZ29NYXAsIGNhdGVnb3J5KSkge1xyXG4gICAgICAgIHJldHVybiBtb25nb01hcFtjYXRlZ29yeV0uZnVsbHBhdGg7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbWFrZUNhbm9uaWNQcm9wZXJ0eU5hbWUoY2F0ZWdvcnkpO1xyXG59XHJcblxyXG4gZXhwb3J0IGZ1bmN0aW9uIHVud2luZHNGb3JOb250ZXJtaW5hbEFycmF5cyhtb25nb01hcCA6IElNYXRjaC5DYXRNb25nb01hcCkgOiBhbnlbXSB7XHJcbiAgICAgdmFyIHBhdGhzID0gT2JqZWN0LmtleXMobW9uZ29NYXApLm1hcChrZXkgPT4gIG1vbmdvTWFwW2tleV0ucGF0aHMpO1xyXG4gICAgIHZhciByZXMgPSBbXTtcclxuICAgICB2YXIgc2VlbkFjY2VzcyA9IHt9IGFzIHsgW2tleTpzdHJpbmddIDogYm9vbGVhbn07XHJcbiAgICAgcmV0dXJuIHBhdGhzLnJlZHVjZSggKHByZXYsIHBhdGgpID0+IHtcclxuICAgICAgICB2YXIgcHJlZml4ID0gJyc7XHJcbiAgICAgICAgcmV0dXJuIHBhdGgucmVkdWNlKCAocHJldiwgc2VnbWVudCwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgaWYocGF0aC5sZW5ndGggLSAxICAhPT0gaW5kZXgpIHtcclxuICAgICAgICAgICAgICAgIC8vIGxhc3Qgc2VnbWVudCBuZXZlciBvZiBpbnRlcmVzdCwgZXZlbiBpZiBbXVxyXG4gICAgICAgICAgICAgICAgaWYoc2VnbWVudCA9PT0nW10nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGV4cGFuZFBhdGggPSBjb25zdHJ1Y3RQYXRoKHBhdGgsaW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKCFzZWVuQWNjZXNzW2V4cGFuZFBhdGhdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlZW5BY2Nlc3NbZXhwYW5kUGF0aF0gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2LnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHVud2luZCA6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoIDogZXhwYW5kUGF0aCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVzZXJ2ZU51bGxBbmRFbXB0eUFycmF5cyA6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHByZXY7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHByZXY7XHJcbiAgICAgICAgfSwgcHJldik7XHJcbiAgICAgfSwgcmVzKTtcclxuIH1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBtYWtlTW9uZ29NYXAob0RvYyA6IElNYXRjaC5JTW9kZWxEb2MsIGVTY2hlbWEgOiBJU2NoZW1hLklFeHRlbmRlZFNjaGVtYSApIDogSU1hdGNoLkNhdE1vbmdvTWFwIHtcclxuICAgIHZhciBvTW9uZ29NYXAgPSB7fSBhcyBDYXRNb25nb01hcDtcclxuICAgIGRlYnVnbG9nKCAoKSA9PiAnY3JlYXRpbmcgbW9uZ29tYXAgZm9yICcgKyBKU09OLnN0cmluZ2lmeShlU2NoZW1hLm1vZGVsbmFtZSwgdW5kZWZpbmVkLCAyKSArICcgYW5kICcgKyBvRG9jLm1vZGVsbmFtZSApO1xyXG4gICAgZGVidWdsb2coICgpID0+J2NyZWF0aW5nIG1vbmdvbWFwIGZvciBkb2MgJyArIEpTT04uc3RyaW5naWZ5KG9Eb2MsIHVuZGVmaW5lZCwgMikpO1xyXG4gICAgZGVidWdsb2coICgpID0+J2NvbGxldGluZyBmcm9tIGVTY2hlbWEucHJvcHMnICsgSlNPTi5zdHJpbmdpZnkoZVNjaGVtYS5wcm9wcyx1bmRlZmluZWQsMikpO1xyXG4gICAgdmFyIHJlcyA9IGNvbGxlY3RDYXRlZ29yaWVzKGVTY2hlbWEucHJvcHMpO1xyXG4gICAgb0RvYy5fY2F0ZWdvcmllcy5mb3JFYWNoKGNhdCA9PiB7XHJcbiAgICAgICAgLy8gY3Jvc3MgY2hlY2tcclxuICAgICAgICBpZighcmVzW2NhdC5jYXRlZ29yeV0pIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ2hlcmUgcHJlc2VudCBrZXlzJyArIE9iamVjdC5rZXlzKHJlcykuc29ydCgpLmpvaW4oXCI7IFwiKSk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBjYXRlZ29yeSAke2NhdC5jYXRlZ29yeX0gaXMgbm90IGluIGVTY2hlbWFgKTsgLy8gKyBKU09OLnN0cmluZ2lmeShlU2NoZW1hLHVuZGVmaW5lZCwyKVxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgZG9jdW1lbnQgaGFzIGArIG9Eb2MuX2NhdGVnb3JpZXMubWFwKGNhdCA9PiBjYXQuY2F0ZWdvcnkpLmpvaW4oJzsgJykpO1xyXG4vL3Byb2Nlc3MuZXhpdCgtMSk7XHJcbiAgICAgICAgICAgY29uc29sZS5sb2coYGNhdGVnb3J5IFwiJHtjYXQuY2F0ZWdvcnl9XCIgaXMgbm90IGluIGVTY2hlbWEgZm9yICR7b0RvYy5tb2RlbG5hbWV9ICsgJHtlU2NoZW1hLm1vZGVsbmFtZX0gOiBgXHJcbiAgICAgICAgICAgICsgXCI9PT09PVNjaGVtYTpcXG5cIisgSlNPTi5zdHJpbmdpZnkoZVNjaGVtYSx1bmRlZmluZWQsMikuc3Vic3RyaW5nKDAsNDAwKVxyXG4gICAgICAgICAgICArIFwiXFxuPT09PT09PT1vRG9jOiBcXG5cIiArIEpTT04uc3RyaW5naWZ5KG9Eb2MsdW5kZWZpbmVkLDIpLnN1YnN0cmluZygwLDQwMCkpO1xyXG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGNhdGVnb3J5ICR7Y2F0LmNhdGVnb3J5fSBpcyBub3QgaW4gZVNjaGVtYSBmb3IgJHtvRG9jLm1vZGVsbmFtZX0gKyAke2VTY2hlbWEubW9kZWxuYW1lfSA6IGBcclxuICAgICAgICAgICAgKyBKU09OLnN0cmluZ2lmeShlU2NoZW1hLHVuZGVmaW5lZCwyKS5zdWJzdHJpbmcoMCwyMDApXHJcbiAgICAgICAgICAgICsgXCJcXG49PT09PT09PT09PSBcIiArIEpTT04uc3RyaW5naWZ5KG9Eb2MsdW5kZWZpbmVkLDIpLnN1YnN0cmluZygwLDQwMCkpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHJlcztcclxufVxyXG5cclxuIl19
