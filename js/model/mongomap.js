"use strict";
/**
 * Functionality to map the "flat" categories model to a nested document
 *
 * @file
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeMongoMap = exports.unwindsForNonterminalArrays = exports.getShortProjectedName = exports.isNonObjectPath = exports.makeCanonicPropertyName = exports.getFirstSegment = exports.makeCategoryPath = exports.getFirstMemberByPath = exports.getMemberByPath = exports.collectMemberByPath = exports.findEschemaPropForCategory = exports.collectCategories = void 0;
//import * as intf from 'constants';
const debug = require("debugf");
var debuglog = debug('mongomap');
const process = require("process");
const _ = require("lodash");
/**
 * the model path, may be controlled via environment variable
 */
var envModelPath = process.env["ABOT_MODELPATH"] || "node_modules/abot_testmodel/testmodel";
function traverseExecutingContext(obj, context) {
    _.forIn(obj, function (val, key) {
        // console.log(key + " -> " + val + " ");
        context.visit(obj, key, val);
        if (_.isArray(val)) {
            context.enterArray(key, val);
            val.forEach(function (el) {
                if (_.isObject(el)) {
                    traverseExecutingContext(el, context);
                }
            });
            context.leaveArray(key, val);
            // console.log('leaving array key' + key  + " " + JSON.stringify(val));
        }
        else if (_.isObject(val)) {
            //  if( _.isArray(val) && _.isObject(val)) {
            //&&      console.log('ABCXASDFS');
            //  };
            //   console.log('is also object' + JSON.stringify(val));
            context.enterObject(key, val);
            traverseExecutingContext(val, context);
            context.leaveObject(key, val);
        }
    });
}
function collectCategories(eSchemaProps) {
    var oContext = {
        res: {},
        plainPath: [],
        currentPath: [],
        enterObject: function (key, val) {
            this.currentPath.push(key);
            this.plainPath.push(key);
        },
        visit: function (obj, key, val) {
            if (key === '_m_category') {
                var lastSeg = this.plainPath[this.plainPath.length - 1];
                this.res[val] = {
                    paths: this.currentPath.slice(),
                    fullpath: this.plainPath.join('.'),
                    shortName: lastSeg
                };
            }
        },
        leaveObject: function (key, val) {
            this.currentPath.pop();
            this.plainPath.pop();
        },
        enterArray: function (key, val) {
            this.enterObject(key, val);
            this.currentPath.push('[]');
        },
        leaveArray: function (key, val) {
            this.leaveObject(key, val);
            this.currentPath.pop();
        }
    };
    traverseExecutingContext(eSchemaProps, oContext);
    return oContext.res;
}
exports.collectCategories = collectCategories;
function findEschemaPropForCategory(eSchemaProps, category) {
    var prop = findEschemaPropForCategoryInt(eSchemaProps, category);
    if (prop._m_category != category) {
        throw new Error("Mismatch between category and prop " + category + " " + JSON.stringify(prop));
    }
    return prop;
}
exports.findEschemaPropForCategory = findEschemaPropForCategory;
function unwrapArrayOne(a) {
    if (_.isArray(a) && a.length == 1) {
        return a[0];
    }
    return a;
}
function findEschemaPropForCategoryInt(eSchemaProps, category) {
    var propName = makeCanonicPropertyName(category);
    var direct = eSchemaProps[propName];
    // todo: there is an ambiguity between 
    //  "category_synonyms" : [{ "type" : "String" , "_m_category":"category_synonyms"}]
    // and 
    //  "category_synonyms" : { "type" : ["String"] , "_m_category":"category_synonyms"}
    // see e.g. sendertyp , see also the spurious Items type for standort
    if (direct) {
        return unwrapArrayOne(direct);
    }
    var res = { r: undefined };
    var oContext = {
        enterObject: function (key, val) {
        },
        visit: function (obj, key, val) {
            if ((_.isObject(val) || _.isArray(val)) && propName == key) {
                if (res.r) {
                    throw new Error("Duplicate property " + propName + " " + JSON.stringify(res.r) + " now " + JSON.stringify(val));
                }
                debuglog('found prop ' + JSON.stringify(res.r) + ' looking for ' + category + ' in ' + JSON.stringify(eSchemaProps));
                res.r = unwrapArrayOne(val);
            }
        },
        leaveObject: function (key, val) {
        },
        enterArray: function (key, val) {
        },
        leaveArray: function (key, val) {
        }
    };
    traverseExecutingContext(eSchemaProps, oContext);
    return res.r;
}
/**
 *
 * @param rec
 * @param paths
 */
function collectMemberByPath(rec, paths) {
    var root = rec;
    if (rec == undefined) {
        return [];
    }
    return paths.reduce((prev, segment, index) => {
        debuglog(() => `at index ${index} segment ${segment} on ${JSON.stringify(prev)}`);
        if (prev === undefined || prev === null) {
            return undefined;
        }
        if (segment !== "[]") {
            var next = prev.map(o => o[segment]).filter(p => (p !== undefined));
            return _.flatten(next);
        }
        else {
            return prev;
        }
    }, [rec]);
}
exports.collectMemberByPath = collectMemberByPath;
/**
 * Given a record and a paths expression, return
 * the value (string or array) which represents this path
 *
 * This method has a slight ambiguity w.r.t. single or multivalued results.
 *   e.g. abc : [{hij : 2}]       will return [2], not 2.
 *
 *
 * Note that a trailing array is not expanded,
 * @param rec
 * @param paths
 */
function getMemberByPath(rec, paths) {
    var root = rec;
    var res = paths.reduce((prev, segment, index) => {
        debuglog(() => `at index ${index} segment ${segment} on ${JSON.stringify(prev)}`);
        if (prev === undefined || prev === null) {
            return undefined;
        }
        if (segment !== "[]") {
            debuglog(' segment ' + index + ' ' + segment + ' ');
            if (_.isArray(prev)) {
                var ru = prev.map(o => o[segment]).filter(o => !!o);
                debuglog(' here result segment ' + index + ' category ' + segment + ' result ' + JSON.stringify(ru));
                return ru.length ? ru : undefined;
            }
            else {
                debuglog(' no array ' + index + ' category ' + segment + ' result ' + JSON.stringify(prev[segment]));
                return prev[segment];
            }
        }
        else {
            if (index === (paths.length - 1)) {
                return prev;
            }
            if (_.isArray(prev)) {
                return prev;
            }
            else {
                return prev;
            }
        }
    }, rec);
    debuglog(() => ` here result ` + res);
    return res;
}
exports.getMemberByPath = getMemberByPath;
function getFirstMemberByPath(rec, paths) {
    var res = getMemberByPath(rec, paths);
    if (res && _.isArray(res)) {
        return res[0];
    }
    return res;
}
exports.getFirstMemberByPath = getFirstMemberByPath;
function constructPath(paths, len) {
    return paths.slice(0, len).filter(seg => seg !== '[]').join('.');
}
/**
 * return a category
 * @param mongoMap
 * @param cat a category
 * @return the constructed path
 */
function makeCategoryPath(mongoMap, category) {
    return mongoMap[category].fullpath;
}
exports.makeCategoryPath = makeCategoryPath;
/**
 * Given a segment path, return the
 * @param paths
 */
function getFirstSegment(paths) {
    if (paths[0] === '[]' || paths.length === 0) {
        throw new Error('did not expect a full array');
    }
    return paths[0];
}
exports.getFirstSegment = getFirstSegment;
function makeCanonicPropertyName(category) {
    // no lowercasing!
    return category.replace(/[^a-zA-Z0-9]/g, '_');
}
exports.makeCanonicPropertyName = makeCanonicPropertyName;
function isNonObjectPath(mongoMap, category) {
    return mongoMap[category].fullpath.indexOf(".") < 0;
}
exports.isNonObjectPath = isNonObjectPath;
function getShortProjectedName(mongoMap, category) {
    if (isNonObjectPath(mongoMap, category)) {
        return mongoMap[category].fullpath;
    }
    return makeCanonicPropertyName(category);
}
exports.getShortProjectedName = getShortProjectedName;
function unwindsForNonterminalArrays(mongoMap) {
    var paths = Object.keys(mongoMap).map(key => mongoMap[key].paths);
    var res = [];
    var seenAccess = {};
    return paths.reduce((prev, path) => {
        var prefix = '';
        return path.reduce((prev, segment, index) => {
            if (path.length - 1 !== index) {
                // last segment never of interest, even if []
                if (segment === '[]') {
                    var expandPath = constructPath(path, index);
                    if (!seenAccess[expandPath]) {
                        seenAccess[expandPath] = true;
                        prev.push({
                            $unwind: {
                                path: expandPath,
                                preserveNullAndEmptyArrays: true
                            }
                        });
                    }
                }
                return prev;
            }
            return prev;
        }, prev);
    }, res);
}
exports.unwindsForNonterminalArrays = unwindsForNonterminalArrays;
function makeMongoMap(oDoc, eSchema) {
    var oMongoMap = {};
    debuglog(() => 'creating mongomap for ' + JSON.stringify(eSchema.modelname, undefined, 2) + ' and ' + oDoc.modelname);
    debuglog(() => 'creating mongomap for doc ' + JSON.stringify(oDoc, undefined, 2));
    debuglog(() => 'colleting from eSchema.props' + JSON.stringify(eSchema.props, undefined, 2));
    var res = collectCategories(eSchema.props);
    oDoc._categories.forEach(cat => {
        // cross check
        if (!res[cat.category]) {
            console.log('here present keys' + Object.keys(res).sort().join("; "));
            console.log(`category ${cat.category} is not in eSchema`); // + JSON.stringify(eSchema,undefined,2)
            console.log(`document has ` + oDoc._categories.map(cat => cat.category).join('; '));
            //process.exit(-1);
            console.log(`category "${cat.category}" is not in eSchema for ${oDoc.modelname} + ${eSchema.modelname} : `
                + "=====Schema:\n" + JSON.stringify(eSchema, undefined, 2).substring(0, 400)
                + "\n========oDoc: \n" + JSON.stringify(oDoc, undefined, 2).substring(0, 400));
            process.exit(-1);
            throw new Error(`category ${cat.category} is not in eSchema for ${oDoc.modelname} + ${eSchema.modelname} : `
                + JSON.stringify(eSchema, undefined, 2).substring(0, 200)
                + "\n=========== " + JSON.stringify(oDoc, undefined, 2).substring(0, 400));
        }
    });
    return res;
}
exports.makeMongoMap = makeMongoMap;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC9tb25nb21hcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7R0FJRzs7O0FBR0gsb0NBQW9DO0FBQ3BDLGdDQUFnQztBQUVoQyxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7QUFhakMsbUNBQW1DO0FBQ25DLDRCQUE0QjtBQUc1Qjs7R0FFRztBQUNILElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsSUFBSSx1Q0FBdUMsQ0FBQztBQUc1RixTQUFTLHdCQUF3QixDQUFDLEdBQUcsRUFBRSxPQUFPO0lBQzFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLFVBQVUsR0FBRyxFQUFFLEdBQUc7UUFDM0IseUNBQXlDO1FBQ3pDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM1QixJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDaEIsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUMsR0FBRyxDQUFDLENBQUM7WUFDNUIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFTLEVBQUU7Z0JBQ25CLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRTtvQkFDaEIsd0JBQXdCLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2lCQUN6QztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUMsR0FBRyxDQUFDLENBQUM7WUFDN0IsdUVBQXVFO1NBQ3pFO2FBQ0ksSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3hCLDRDQUE0QztZQUM1QyxtQ0FBbUM7WUFDbkMsTUFBTTtZQUNQLHlEQUF5RDtZQUN0RCxPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUM5Qix3QkFBd0IsQ0FBQyxHQUFHLEVBQUMsT0FBTyxDQUFDLENBQUM7WUFDdEMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUMsR0FBRyxDQUFDLENBQUM7U0FDaEM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxTQUFnQixpQkFBaUIsQ0FBQyxZQUFrQjtJQUNoRCxJQUFJLFFBQVEsR0FBRztRQUNYLEdBQUcsRUFBRyxFQUFpQjtRQUN2QixTQUFTLEVBQUcsRUFBRTtRQUNkLFdBQVcsRUFBRyxFQUFFO1FBQ2hCLFdBQVcsRUFBRyxVQUFTLEdBQVcsRUFBRSxHQUFRO1lBQ3hDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzdCLENBQUM7UUFDRCxLQUFLLEVBQUUsVUFBUyxHQUFTLEVBQUUsR0FBVyxFQUFFLEdBQVE7WUFDNUMsSUFBRyxHQUFHLEtBQUssYUFBYSxFQUFFO2dCQUN0QixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN0RCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHO29CQUNaLEtBQUssRUFBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRTtvQkFDaEMsUUFBUSxFQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztvQkFDbkMsU0FBUyxFQUFHLE9BQU87aUJBQ3RCLENBQUE7YUFDSjtRQUNMLENBQUM7UUFDRCxXQUFXLEVBQUcsVUFBUyxHQUFXLEVBQUUsR0FBUTtZQUN4QyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDekIsQ0FBQztRQUNELFVBQVUsRUFBRyxVQUFTLEdBQVksRUFBRSxHQUFRO1lBQ3hDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQzNCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hDLENBQUM7UUFDRCxVQUFVLEVBQUcsVUFBUyxHQUFZLEVBQUUsR0FBUTtZQUN4QyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUMzQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzNCLENBQUM7S0FDSixDQUFBO0lBQ0Qsd0JBQXdCLENBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBRSxDQUFDO0lBQ2xELE9BQU8sUUFBUSxDQUFDLEdBQUcsQ0FBQztBQUN4QixDQUFDO0FBbENELDhDQWtDQztBQUdELFNBQWdCLDBCQUEwQixDQUFDLFlBQWtCLEVBQUUsUUFBaUI7SUFDNUUsSUFBSSxJQUFJLEdBQUcsNkJBQTZCLENBQUMsWUFBWSxFQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2hFLElBQUssSUFBSSxDQUFDLFdBQVcsSUFBSSxRQUFRLEVBQUU7UUFDL0IsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQ0FBcUMsR0FBRyxRQUFRLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztLQUNsRztJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUM7QUFORCxnRUFNQztBQUVELFNBQVMsY0FBYyxDQUFDLENBQU07SUFDMUIsSUFBSyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFHO1FBQ2pDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2Y7SUFDRCxPQUFPLENBQUMsQ0FBQztBQUNiLENBQUM7QUFFRCxTQUFTLDZCQUE2QixDQUFDLFlBQWtCLEVBQUUsUUFBaUI7SUFDeEUsSUFBSSxRQUFRLEdBQUcsdUJBQXVCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDakQsSUFBSSxNQUFNLEdBQUcsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3BDLHVDQUF1QztJQUN2QyxvRkFBb0Y7SUFDcEYsT0FBTztJQUNQLG9GQUFvRjtJQUNwRixxRUFBcUU7SUFDckUsSUFBSyxNQUFNLEVBQUc7UUFDWCxPQUFPLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUNoQztJQUNELElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDO0lBQzNCLElBQUksUUFBUSxHQUFHO1FBQ1gsV0FBVyxFQUFHLFVBQVMsR0FBVyxFQUFFLEdBQVE7UUFDNUMsQ0FBQztRQUNELEtBQUssRUFBRSxVQUFTLEdBQVMsRUFBRSxHQUFXLEVBQUUsR0FBUTtZQUM1QyxJQUFLLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksUUFBUSxJQUFJLEdBQUcsRUFBRTtnQkFDekQsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFJO29CQUNULE1BQU0sSUFBSSxLQUFLLENBQUMscUJBQXFCLEdBQUcsUUFBUSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2lCQUNuSDtnQkFDRCxRQUFRLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLGVBQWUsR0FBRyxRQUFRLEdBQUcsTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztnQkFDckgsR0FBRyxDQUFDLENBQUMsR0FBSSxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDaEM7UUFDTCxDQUFDO1FBQ0QsV0FBVyxFQUFHLFVBQVMsR0FBVyxFQUFFLEdBQVE7UUFDNUMsQ0FBQztRQUNELFVBQVUsRUFBRyxVQUFTLEdBQVksRUFBRSxHQUFRO1FBQzVDLENBQUM7UUFDRCxVQUFVLEVBQUcsVUFBUyxHQUFZLEVBQUUsR0FBUTtRQUM1QyxDQUFDO0tBQ0osQ0FBQTtJQUNELHdCQUF3QixDQUFDLFlBQVksRUFBRSxRQUFRLENBQUUsQ0FBQztJQUNsRCxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDakIsQ0FBQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFnQixtQkFBbUIsQ0FBQyxHQUFTLEVBQUUsS0FBZ0I7SUFDM0QsSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDO0lBQ2YsSUFBSyxHQUFHLElBQUksU0FBUyxFQUFFO1FBQ25CLE9BQU8sRUFBRSxDQUFDO0tBQ2I7SUFDRCxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFDLEtBQUssRUFBRSxFQUFFO1FBQ3pDLFFBQVEsQ0FBQyxHQUFFLEVBQUUsQ0FBQyxZQUFZLEtBQUssWUFBWSxPQUFPLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFakYsSUFBRyxJQUFJLEtBQUssU0FBUyxJQUFJLElBQUksS0FBSyxJQUFJLEVBQUU7WUFDcEMsT0FBTyxTQUFTLENBQUM7U0FDcEI7UUFDRCxJQUFHLE9BQU8sS0FBSyxJQUFJLEVBQUU7WUFDakIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFFLENBQUM7WUFDdkUsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFFLElBQUksQ0FBQyxDQUFDO1NBQzNCO2FBQU07WUFDSCxPQUFPLElBQUksQ0FBQztTQUNmO0lBQ0wsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUNkLENBQUM7QUFsQkQsa0RBa0JDO0FBQ0Q7Ozs7Ozs7Ozs7O0dBV0c7QUFDSCxTQUFnQixlQUFlLENBQUMsR0FBUyxFQUFFLEtBQWU7SUFDdEQsSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDO0lBQ2YsSUFBSSxHQUFHLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBRSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUMsS0FBSyxFQUFFLEVBQUU7UUFDNUMsUUFBUSxDQUFDLEdBQUUsRUFBRSxDQUFDLFlBQVksS0FBSyxZQUFZLE9BQU8sT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNqRixJQUFHLElBQUksS0FBSyxTQUFTLElBQUksSUFBSSxLQUFLLElBQUksRUFBRTtZQUNwQyxPQUFPLFNBQVMsQ0FBQztTQUNwQjtRQUNELElBQUcsT0FBTyxLQUFLLElBQUksRUFBRTtZQUNqQixRQUFRLENBQUMsV0FBVyxHQUFHLEtBQUssR0FBRyxHQUFHLEdBQUcsT0FBTyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1lBQ3BELElBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRztnQkFDbkIsSUFBSSxFQUFFLEdBQUksSUFBSSxDQUFDLEdBQUcsQ0FBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUUsQ0FBQztnQkFDeEQsUUFBUSxDQUFDLHVCQUF1QixHQUFHLEtBQUssR0FBRyxZQUFZLEdBQUcsT0FBTyxHQUFHLFVBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3JHLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7YUFDckM7aUJBQU07Z0JBQ0gsUUFBUSxDQUFDLFlBQVksR0FBRyxLQUFLLEdBQUcsWUFBWSxHQUFHLE9BQU8sR0FBRyxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNyRyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUN4QjtTQUNKO2FBQU07WUFDSCxJQUFHLEtBQUssS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEVBQUU7Z0JBQzdCLE9BQU8sSUFBSSxDQUFDO2FBQ2Y7WUFDRCxJQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQ2hCLE9BQU8sSUFBSSxDQUFDO2FBQ2Y7aUJBQU07Z0JBQ0gsT0FBTyxJQUFJLENBQUM7YUFDZjtTQUNKO0lBQ0wsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ1IsUUFBUSxDQUFDLEdBQUUsRUFBRSxDQUFDLGVBQWUsR0FBRyxHQUFHLENBQUMsQ0FBQztJQUNyQyxPQUFPLEdBQUcsQ0FBQztBQUNmLENBQUM7QUE5QkQsMENBOEJDO0FBRUQsU0FBZ0Isb0JBQW9CLENBQUMsR0FBUyxFQUFFLEtBQWU7SUFDM0QsSUFBSSxHQUFHLEdBQUcsZUFBZSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN0QyxJQUFLLEdBQUcsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1FBQ3hCLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2pCO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDZixDQUFDO0FBTkQsb0RBTUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxLQUFpQixFQUFFLEdBQVk7SUFDbEQsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3JFLENBQUM7QUFHRDs7Ozs7R0FLRztBQUNILFNBQWdCLGdCQUFnQixDQUFDLFFBQTRCLEVBQUcsUUFBaUI7SUFDN0UsT0FBTyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDO0FBQ3ZDLENBQUM7QUFGRCw0Q0FFQztBQUVEOzs7R0FHRztBQUNILFNBQWdCLGVBQWUsQ0FBQyxLQUFnQjtJQUM1QyxJQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLElBQUssS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUc7UUFDMUMsTUFBTSxJQUFJLEtBQUssQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0tBQ2xEO0lBQ0QsT0FBTyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEIsQ0FBQztBQUxELDBDQUtDO0FBRUQsU0FBZ0IsdUJBQXVCLENBQUMsUUFBaUI7SUFDckQsa0JBQWtCO0lBQ2xCLE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUMsR0FBRyxDQUFDLENBQUM7QUFDakQsQ0FBQztBQUhELDBEQUdDO0FBRUQsU0FBZ0IsZUFBZSxDQUFDLFFBQTZCLEVBQUUsUUFBaUI7SUFDNUUsT0FBTyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDeEQsQ0FBQztBQUZELDBDQUVDO0FBRUQsU0FBZ0IscUJBQXFCLENBQUMsUUFBNEIsRUFBRSxRQUFpQjtJQUNqRixJQUFHLGVBQWUsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLEVBQUU7UUFDcEMsT0FBTyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDO0tBQ3RDO0lBQ0QsT0FBTyx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM3QyxDQUFDO0FBTEQsc0RBS0M7QUFFQSxTQUFnQiwyQkFBMkIsQ0FBQyxRQUE2QjtJQUNyRSxJQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNuRSxJQUFJLEdBQUcsR0FBRyxFQUFFLENBQUM7SUFDYixJQUFJLFVBQVUsR0FBRyxFQUErQixDQUFDO0lBQ2pELE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsRUFBRTtRQUNqQyxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDaEIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFFLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRTtZQUN6QyxJQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxLQUFNLEtBQUssRUFBRTtnQkFDM0IsNkNBQTZDO2dCQUM3QyxJQUFHLE9BQU8sS0FBSSxJQUFJLEVBQUU7b0JBQ2hCLElBQUksVUFBVSxHQUFHLGFBQWEsQ0FBQyxJQUFJLEVBQUMsS0FBSyxDQUFDLENBQUM7b0JBQzNDLElBQUcsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUU7d0JBQ3hCLFVBQVUsQ0FBQyxVQUFVLENBQUMsR0FBRyxJQUFJLENBQUM7d0JBQzlCLElBQUksQ0FBQyxJQUFJLENBQUM7NEJBQ04sT0FBTyxFQUFHO2dDQUNOLElBQUksRUFBRyxVQUFVO2dDQUNqQiwwQkFBMEIsRUFBRyxJQUFJOzZCQUNwQzt5QkFDSixDQUFDLENBQUM7cUJBQ047aUJBQ0o7Z0JBQ0QsT0FBTyxJQUFJLENBQUM7YUFDZjtZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNaLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUNaLENBQUM7QUExQkQsa0VBMEJDO0FBRUYsU0FBZ0IsWUFBWSxDQUFDLElBQXVCLEVBQUUsT0FBaUM7SUFDbkYsSUFBSSxTQUFTLEdBQUcsRUFBaUIsQ0FBQztJQUNsQyxRQUFRLENBQUUsR0FBRyxFQUFFLENBQUMsd0JBQXdCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsR0FBRyxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBRSxDQUFDO0lBQ3hILFFBQVEsQ0FBRSxHQUFHLEVBQUUsQ0FBQSw0QkFBNEIsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsRixRQUFRLENBQUUsR0FBRyxFQUFFLENBQUEsOEJBQThCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFDLFNBQVMsRUFBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNGLElBQUksR0FBRyxHQUFHLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMzQyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUMzQixjQUFjO1FBQ2QsSUFBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDbkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3RFLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxHQUFHLENBQUMsUUFBUSxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsd0NBQXdDO1lBQ25HLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxHQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQy9GLG1CQUFtQjtZQUNSLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxHQUFHLENBQUMsUUFBUSwyQkFBMkIsSUFBSSxDQUFDLFNBQVMsTUFBTSxPQUFPLENBQUMsU0FBUyxLQUFLO2tCQUN2RyxnQkFBZ0IsR0FBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBQyxTQUFTLEVBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBQyxHQUFHLENBQUM7a0JBQ3RFLG9CQUFvQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFDLFNBQVMsRUFBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDNUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLE1BQU0sSUFBSSxLQUFLLENBQUMsWUFBWSxHQUFHLENBQUMsUUFBUSwwQkFBMEIsSUFBSSxDQUFDLFNBQVMsTUFBTSxPQUFPLENBQUMsU0FBUyxLQUFLO2tCQUMxRyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBQyxTQUFTLEVBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBQyxHQUFHLENBQUM7a0JBQ3BELGdCQUFnQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFDLFNBQVMsRUFBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDM0U7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sR0FBRyxDQUFDO0FBQ2YsQ0FBQztBQXZCRCxvQ0F1QkMiLCJmaWxlIjoibW9kZWwvbW9uZ29tYXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogRnVuY3Rpb25hbGl0eSB0byBtYXAgdGhlIFwiZmxhdFwiIGNhdGVnb3JpZXMgbW9kZWwgdG8gYSBuZXN0ZWQgZG9jdW1lbnRcclxuICpcclxuICogQGZpbGVcclxuICovXHJcblxyXG5cclxuLy9pbXBvcnQgKiBhcyBpbnRmIGZyb20gJ2NvbnN0YW50cyc7XHJcbmltcG9ydCAqIGFzIGRlYnVnIGZyb20gJ2RlYnVnZic7XHJcblxyXG52YXIgZGVidWdsb2cgPSBkZWJ1ZygnbW9uZ29tYXAnKTtcclxuXHJcbmltcG9ydCAqIGFzIElTY2hlbWEgZnJvbSAnLi4vbW9kZWxsb2FkL3NjaGVtYWxvYWQnO1xyXG4vL2NvbnN0IGxvYWRsb2cgPSBsb2dnZXIubG9nZ2VyKCdtb2RlbGxvYWQnLCAnJyk7XHJcblxyXG5pbXBvcnQgKiAgYXMgSU1hdGNoIGZyb20gJy4uL21hdGNoL2lmbWF0Y2gnO1xyXG5pbXBvcnQgKiBhcyBJbnB1dEZpbHRlclJ1bGVzIGZyb20gJy4uL21hdGNoL3J1bGUnO1xyXG4vL2ltcG9ydCAqIGFzIFRvb2xzIGZyb20gJy4uL21hdGNoL3Rvb2xzJztcclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xyXG5pbXBvcnQgKiBhcyBNZXRhIGZyb20gJy4vbWV0YSc7XHJcbmltcG9ydCAqIGFzIFV0aWxzIGZyb20gJ2Fib3RfdXRpbHMnO1xyXG5pbXBvcnQgKiBhcyBDaXJjdWxhclNlciBmcm9tICdhYm90X3V0aWxzJztcclxuaW1wb3J0ICogYXMgRGlzdGFuY2UgZnJvbSAnYWJvdF9zdHJpbmdkaXN0JztcclxuaW1wb3J0ICogYXMgcHJvY2VzcyBmcm9tICdwcm9jZXNzJztcclxuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xyXG5cclxudHlwZSBDYXRNb25nb01hcCA9IElNYXRjaC5DYXRNb25nb01hcDtcclxuLyoqXHJcbiAqIHRoZSBtb2RlbCBwYXRoLCBtYXkgYmUgY29udHJvbGxlZCB2aWEgZW52aXJvbm1lbnQgdmFyaWFibGVcclxuICovXHJcbnZhciBlbnZNb2RlbFBhdGggPSBwcm9jZXNzLmVudltcIkFCT1RfTU9ERUxQQVRIXCJdIHx8IFwibm9kZV9tb2R1bGVzL2Fib3RfdGVzdG1vZGVsL3Rlc3Rtb2RlbFwiO1xyXG5cclxuXHJcbmZ1bmN0aW9uIHRyYXZlcnNlRXhlY3V0aW5nQ29udGV4dChvYmosIGNvbnRleHQpIHtcclxuICAgIF8uZm9ySW4ob2JqLCBmdW5jdGlvbiAodmFsLCBrZXkpIHtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZyhrZXkgKyBcIiAtPiBcIiArIHZhbCArIFwiIFwiKTtcclxuICAgICAgICBjb250ZXh0LnZpc2l0KG9iaixrZXksIHZhbCk7XHJcbiAgICAgICAgaWYgKF8uaXNBcnJheSh2YWwpKSB7XHJcbiAgICAgICAgICAgIGNvbnRleHQuZW50ZXJBcnJheShrZXksdmFsKTtcclxuICAgICAgICAgICAgdmFsLmZvckVhY2goZnVuY3Rpb24oZWwpIHtcclxuICAgICAgICAgICAgICAgIGlmIChfLmlzT2JqZWN0KGVsKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRyYXZlcnNlRXhlY3V0aW5nQ29udGV4dChlbCwgY29udGV4dCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBjb250ZXh0LmxlYXZlQXJyYXkoa2V5LHZhbCk7XHJcbiAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2xlYXZpbmcgYXJyYXkga2V5JyArIGtleSAgKyBcIiBcIiArIEpTT04uc3RyaW5naWZ5KHZhbCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmIChfLmlzT2JqZWN0KHZhbCkpIHtcclxuICAgICAgICAgIC8vICBpZiggXy5pc0FycmF5KHZhbCkgJiYgXy5pc09iamVjdCh2YWwpKSB7XHJcbiAgICAgICAgICAvLyYmICAgICAgY29uc29sZS5sb2coJ0FCQ1hBU0RGUycpO1xyXG4gICAgICAgICAgLy8gIH07XHJcbiAgICAgICAgIC8vICAgY29uc29sZS5sb2coJ2lzIGFsc28gb2JqZWN0JyArIEpTT04uc3RyaW5naWZ5KHZhbCkpO1xyXG4gICAgICAgICAgICBjb250ZXh0LmVudGVyT2JqZWN0KGtleSwgdmFsKTtcclxuICAgICAgICAgICAgdHJhdmVyc2VFeGVjdXRpbmdDb250ZXh0KHZhbCxjb250ZXh0KTtcclxuICAgICAgICAgICAgY29udGV4dC5sZWF2ZU9iamVjdChrZXksdmFsKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNvbGxlY3RDYXRlZ29yaWVzKGVTY2hlbWFQcm9wcyA6IGFueSkge1xyXG4gICAgdmFyIG9Db250ZXh0ID0ge1xyXG4gICAgICAgIHJlcyA6IHt9IGFzIENhdE1vbmdvTWFwLFxyXG4gICAgICAgIHBsYWluUGF0aCA6IFtdLFxyXG4gICAgICAgIGN1cnJlbnRQYXRoIDogW10sXHJcbiAgICAgICAgZW50ZXJPYmplY3QgOiBmdW5jdGlvbihrZXk6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50UGF0aC5wdXNoKGtleSk7XHJcbiAgICAgICAgICAgIHRoaXMucGxhaW5QYXRoLnB1c2goa2V5KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHZpc2l0OiBmdW5jdGlvbihvYmogOiBhbnksIGtleTogc3RyaW5nLCB2YWw6IGFueSkge1xyXG4gICAgICAgICAgICBpZihrZXkgPT09ICdfbV9jYXRlZ29yeScpIHtcclxuICAgICAgICAgICAgICAgIHZhciBsYXN0U2VnID0gdGhpcy5wbGFpblBhdGhbdGhpcy5wbGFpblBhdGgubGVuZ3RoLTFdO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZXNbdmFsXSA9IHtcclxuICAgICAgICAgICAgICAgICAgICBwYXRocyA6IHRoaXMuY3VycmVudFBhdGguc2xpY2UoKSxcclxuICAgICAgICAgICAgICAgICAgICBmdWxscGF0aCA6IHRoaXMucGxhaW5QYXRoLmpvaW4oJy4nKSxcclxuICAgICAgICAgICAgICAgICAgICBzaG9ydE5hbWUgOiBsYXN0U2VnXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGxlYXZlT2JqZWN0IDogZnVuY3Rpb24oa2V5OiBzdHJpbmcsIHZhbDogYW55KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFBhdGgucG9wKCk7XHJcbiAgICAgICAgICAgIHRoaXMucGxhaW5QYXRoLnBvcCgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW50ZXJBcnJheSA6IGZ1bmN0aW9uKGtleSA6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICAgICAgdGhpcy5lbnRlck9iamVjdChrZXksIHZhbCk7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFBhdGgucHVzaCgnW10nKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGxlYXZlQXJyYXkgOiBmdW5jdGlvbihrZXkgOiBzdHJpbmcsIHZhbDogYW55KSB7XHJcbiAgICAgICAgICAgIHRoaXMubGVhdmVPYmplY3Qoa2V5LCB2YWwpO1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRQYXRoLnBvcCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHRyYXZlcnNlRXhlY3V0aW5nQ29udGV4dChlU2NoZW1hUHJvcHMsIG9Db250ZXh0ICk7XHJcbiAgICByZXR1cm4gb0NvbnRleHQucmVzO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRFc2NoZW1hUHJvcEZvckNhdGVnb3J5KGVTY2hlbWFQcm9wcyA6IGFueSwgY2F0ZWdvcnkgOiBzdHJpbmcpIDogYW55IHtcclxuICAgIHZhciBwcm9wID0gZmluZEVzY2hlbWFQcm9wRm9yQ2F0ZWdvcnlJbnQoZVNjaGVtYVByb3BzLGNhdGVnb3J5KTtcclxuICAgIGlmICggcHJvcC5fbV9jYXRlZ29yeSAhPSBjYXRlZ29yeSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIk1pc21hdGNoIGJldHdlZW4gY2F0ZWdvcnkgYW5kIHByb3AgXCIgKyBjYXRlZ29yeSArIFwiIFwiICsgSlNPTi5zdHJpbmdpZnkocHJvcCkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHByb3A7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVud3JhcEFycmF5T25lKGE6IGFueSkgOiBhbnkge1xyXG4gICAgaWYgKCBfLmlzQXJyYXkoYSkgJiYgYS5sZW5ndGggPT0gMSApIHtcclxuICAgICAgICByZXR1cm4gYVswXTtcclxuICAgIH1cclxuICAgIHJldHVybiBhO1xyXG59XHJcblxyXG5mdW5jdGlvbiBmaW5kRXNjaGVtYVByb3BGb3JDYXRlZ29yeUludChlU2NoZW1hUHJvcHMgOiBhbnksIGNhdGVnb3J5IDogc3RyaW5nKSA6IGFueSB7XHJcbiAgICB2YXIgcHJvcE5hbWUgPSBtYWtlQ2Fub25pY1Byb3BlcnR5TmFtZShjYXRlZ29yeSk7XHJcbiAgICB2YXIgZGlyZWN0ID0gZVNjaGVtYVByb3BzW3Byb3BOYW1lXTtcclxuICAgIC8vIHRvZG86IHRoZXJlIGlzIGFuIGFtYmlndWl0eSBiZXR3ZWVuIFxyXG4gICAgLy8gIFwiY2F0ZWdvcnlfc3lub255bXNcIiA6IFt7IFwidHlwZVwiIDogXCJTdHJpbmdcIiAsIFwiX21fY2F0ZWdvcnlcIjpcImNhdGVnb3J5X3N5bm9ueW1zXCJ9XVxyXG4gICAgLy8gYW5kIFxyXG4gICAgLy8gIFwiY2F0ZWdvcnlfc3lub255bXNcIiA6IHsgXCJ0eXBlXCIgOiBbXCJTdHJpbmdcIl0gLCBcIl9tX2NhdGVnb3J5XCI6XCJjYXRlZ29yeV9zeW5vbnltc1wifVxyXG4gICAgLy8gc2VlIGUuZy4gc2VuZGVydHlwICwgc2VlIGFsc28gdGhlIHNwdXJpb3VzIEl0ZW1zIHR5cGUgZm9yIHN0YW5kb3J0XHJcbiAgICBpZiAoIGRpcmVjdCApIHtcclxuICAgICAgIHJldHVybiB1bndyYXBBcnJheU9uZShkaXJlY3QpO1xyXG4gICAgfVxyXG4gICAgdmFyIHJlcyA9IHsgcjogdW5kZWZpbmVkIH07XHJcbiAgICB2YXIgb0NvbnRleHQgPSB7XHJcbiAgICAgICAgZW50ZXJPYmplY3QgOiBmdW5jdGlvbihrZXk6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHZpc2l0OiBmdW5jdGlvbihvYmogOiBhbnksIGtleTogc3RyaW5nLCB2YWw6IGFueSkge1xyXG4gICAgICAgICAgICBpZiAoIChfLmlzT2JqZWN0KHZhbCkgfHwgXy5pc0FycmF5KHZhbCkpICYmIHByb3BOYW1lID09IGtleSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlcy5yICkgIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJEdXBsaWNhdGUgcHJvcGVydHkgXCIgKyBwcm9wTmFtZSArIFwiIFwiICsgSlNPTi5zdHJpbmdpZnkocmVzLnIpICsgXCIgbm93IFwiICsgSlNPTi5zdHJpbmdpZnkodmFsKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZygnZm91bmQgcHJvcCAnICsgSlNPTi5zdHJpbmdpZnkocmVzLnIpICsgJyBsb29raW5nIGZvciAnICsgY2F0ZWdvcnkgKyAnIGluICcgKyBKU09OLnN0cmluZ2lmeShlU2NoZW1hUHJvcHMpKTtcclxuICAgICAgICAgICAgICAgIHJlcy5yID0gIHVud3JhcEFycmF5T25lKHZhbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGxlYXZlT2JqZWN0IDogZnVuY3Rpb24oa2V5OiBzdHJpbmcsIHZhbDogYW55KSB7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnRlckFycmF5IDogZnVuY3Rpb24oa2V5IDogc3RyaW5nLCB2YWw6IGFueSkge1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbGVhdmVBcnJheSA6IGZ1bmN0aW9uKGtleSA6IHN0cmluZywgdmFsOiBhbnkpIHtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICB0cmF2ZXJzZUV4ZWN1dGluZ0NvbnRleHQoZVNjaGVtYVByb3BzLCBvQ29udGV4dCApO1xyXG4gICAgcmV0dXJuIHJlcy5yO1xyXG59XHJcblxyXG4vKipcclxuICogXHJcbiAqIEBwYXJhbSByZWMgXHJcbiAqIEBwYXJhbSBwYXRocyBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBjb2xsZWN0TWVtYmVyQnlQYXRoKHJlYyA6IGFueSwgcGF0aHMgOiBzdHJpbmdbXSkgOiBhbnlbXSB7XHJcbiAgICB2YXIgcm9vdCA9IHJlYztcclxuICAgIGlmICggcmVjID09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICAgIHJldHVybiBwYXRocy5yZWR1Y2UoIChwcmV2LCBzZWdtZW50LGluZGV4KSA9PiB7XHJcbiAgICAgICAgZGVidWdsb2coKCk9PiBgYXQgaW5kZXggJHtpbmRleH0gc2VnbWVudCAke3NlZ21lbnR9IG9uICR7SlNPTi5zdHJpbmdpZnkocHJldil9YCk7XHJcblxyXG4gICAgICAgIGlmKHByZXYgPT09IHVuZGVmaW5lZCB8fCBwcmV2ID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmKHNlZ21lbnQgIT09IFwiW11cIikge1xyXG4gICAgICAgICAgICB2YXIgbmV4dCA9IHByZXYubWFwKCBvID0+IG9bc2VnbWVudF0gKS5maWx0ZXIocCA9PiAocCAhPT0gdW5kZWZpbmVkKSApO1xyXG4gICAgICAgICAgICByZXR1cm4gXy5mbGF0dGVuKCBuZXh0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gcHJldjtcclxuICAgICAgICB9XHJcbiAgICB9LCBbcmVjXSk7XHJcbn1cclxuLyoqXHJcbiAqIEdpdmVuIGEgcmVjb3JkIGFuZCBhIHBhdGhzIGV4cHJlc3Npb24sIHJldHVyblxyXG4gKiB0aGUgdmFsdWUgKHN0cmluZyBvciBhcnJheSkgd2hpY2ggcmVwcmVzZW50cyB0aGlzIHBhdGhcclxuICpcclxuICogVGhpcyBtZXRob2QgaGFzIGEgc2xpZ2h0IGFtYmlndWl0eSB3LnIudC4gc2luZ2xlIG9yIG11bHRpdmFsdWVkIHJlc3VsdHMuIFxyXG4gKiAgIGUuZy4gYWJjIDogW3toaWogOiAyfV0gICAgICAgd2lsbCByZXR1cm4gWzJdLCBub3QgMi5cclxuICpcclxuICpcclxuICogTm90ZSB0aGF0IGEgdHJhaWxpbmcgYXJyYXkgaXMgbm90IGV4cGFuZGVkLFxyXG4gKiBAcGFyYW0gcmVjXHJcbiAqIEBwYXJhbSBwYXRoc1xyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldE1lbWJlckJ5UGF0aChyZWMgOiBhbnksIHBhdGhzOiBzdHJpbmdbXSkgIDogYW55IHtcclxuICAgIHZhciByb290ID0gcmVjO1xyXG4gICAgdmFyIHJlcyA9IHBhdGhzLnJlZHVjZSggKHByZXYsIHNlZ21lbnQsaW5kZXgpID0+IHtcclxuICAgICAgICBkZWJ1Z2xvZygoKT0+IGBhdCBpbmRleCAke2luZGV4fSBzZWdtZW50ICR7c2VnbWVudH0gb24gJHtKU09OLnN0cmluZ2lmeShwcmV2KX1gKTtcclxuICAgICAgICBpZihwcmV2ID09PSB1bmRlZmluZWQgfHwgcHJldiA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZihzZWdtZW50ICE9PSBcIltdXCIpIHtcclxuICAgICAgICAgICAgZGVidWdsb2coJyBzZWdtZW50ICcgKyBpbmRleCArICcgJyArIHNlZ21lbnQgKyAnICcpO1xyXG4gICAgICAgICAgICBpZiAoIF8uaXNBcnJheShwcmV2KSApIHtcclxuICAgICAgICAgICAgICAgIHZhciBydSA9ICBwcmV2Lm1hcCggbyA9PiBvW3NlZ21lbnRdKS5maWx0ZXIoIG8gPT4gISFvICk7XHJcbiAgICAgICAgICAgICAgICBkZWJ1Z2xvZygnIGhlcmUgcmVzdWx0IHNlZ21lbnQgJyArIGluZGV4ICsgJyBjYXRlZ29yeSAnICsgc2VnbWVudCArICcgcmVzdWx0ICcgKyBKU09OLnN0cmluZ2lmeShydSkpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJ1Lmxlbmd0aCA/IHJ1IDogdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZGVidWdsb2coJyBubyBhcnJheSAnICsgaW5kZXggKyAnIGNhdGVnb3J5ICcgKyBzZWdtZW50ICsgJyByZXN1bHQgJyArIEpTT04uc3RyaW5naWZ5KHByZXZbc2VnbWVudF0pKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2W3NlZ21lbnRdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYoaW5kZXggPT09IChwYXRocy5sZW5ndGggLSAxKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHByZXY7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYoXy5pc0FycmF5KHByZXYpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldjtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSwgcmVjKTtcclxuICAgIGRlYnVnbG9nKCgpPT4gYCBoZXJlIHJlc3VsdCBgICsgcmVzKTtcclxuICAgIHJldHVybiByZXM7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRGaXJzdE1lbWJlckJ5UGF0aChyZWMgOiBhbnksIHBhdGhzOiBzdHJpbmdbXSkgIDogYW55IHtcclxuICAgIHZhciByZXMgPSBnZXRNZW1iZXJCeVBhdGgocmVjLCBwYXRocyk7XHJcbiAgICBpZiAoIHJlcyAmJiBfLmlzQXJyYXkocmVzKSkge1xyXG4gICAgICAgIHJldHVybiByZXNbMF07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb25zdHJ1Y3RQYXRoKHBhdGhzIDogc3RyaW5nIFtdLCBsZW4gOiBudW1iZXIpIHtcclxuICAgIHJldHVybiBwYXRocy5zbGljZSgwLCBsZW4pLmZpbHRlcihzZWcgPT4gc2VnICE9PSAnW10nKS5qb2luKCcuJyk7XHJcbn1cclxuXHJcblxyXG4vKipcclxuICogcmV0dXJuIGEgY2F0ZWdvcnlcclxuICogQHBhcmFtIG1vbmdvTWFwXHJcbiAqIEBwYXJhbSBjYXQgYSBjYXRlZ29yeVxyXG4gKiBAcmV0dXJuIHRoZSBjb25zdHJ1Y3RlZCBwYXRoXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gbWFrZUNhdGVnb3J5UGF0aChtb25nb01hcDogSU1hdGNoLkNhdE1vbmdvTWFwICwgY2F0ZWdvcnkgOiBzdHJpbmcpIDogc3RyaW5nIHtcclxuICAgIHJldHVybiBtb25nb01hcFtjYXRlZ29yeV0uZnVsbHBhdGg7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHaXZlbiBhIHNlZ21lbnQgcGF0aCwgcmV0dXJuIHRoZVxyXG4gKiBAcGFyYW0gcGF0aHNcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRGaXJzdFNlZ21lbnQocGF0aHMgOiBzdHJpbmdbXSApIDogc3RyaW5nIHtcclxuICAgIGlmKHBhdGhzWzBdID09PSAnW10nICB8fCBwYXRocy5sZW5ndGggPT09IDApICB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdkaWQgbm90IGV4cGVjdCBhIGZ1bGwgYXJyYXknKTtcclxuICAgIH1cclxuICAgIHJldHVybiBwYXRoc1swXTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VDYW5vbmljUHJvcGVydHlOYW1lKGNhdGVnb3J5IDogc3RyaW5nICkgOiBzdHJpbmcge1xyXG4gICAgLy8gbm8gbG93ZXJjYXNpbmchXHJcbiAgICByZXR1cm4gY2F0ZWdvcnkucmVwbGFjZSgvW15hLXpBLVowLTldL2csJ18nKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzTm9uT2JqZWN0UGF0aChtb25nb01hcCA6IElNYXRjaC5DYXRNb25nb01hcCwgY2F0ZWdvcnkgOiBzdHJpbmcpIDogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gbW9uZ29NYXBbY2F0ZWdvcnldLmZ1bGxwYXRoLmluZGV4T2YoXCIuXCIpIDwgMDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFNob3J0UHJvamVjdGVkTmFtZShtb25nb01hcDogSU1hdGNoLkNhdE1vbmdvTWFwLCBjYXRlZ29yeSA6IHN0cmluZykgOiBzdHJpbmcge1xyXG4gICAgaWYoaXNOb25PYmplY3RQYXRoKG1vbmdvTWFwLCBjYXRlZ29yeSkpIHtcclxuICAgICAgICByZXR1cm4gbW9uZ29NYXBbY2F0ZWdvcnldLmZ1bGxwYXRoO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG1ha2VDYW5vbmljUHJvcGVydHlOYW1lKGNhdGVnb3J5KTtcclxufVxyXG5cclxuIGV4cG9ydCBmdW5jdGlvbiB1bndpbmRzRm9yTm9udGVybWluYWxBcnJheXMobW9uZ29NYXAgOiBJTWF0Y2guQ2F0TW9uZ29NYXApIDogYW55W10ge1xyXG4gICAgIHZhciBwYXRocyA9IE9iamVjdC5rZXlzKG1vbmdvTWFwKS5tYXAoa2V5ID0+ICBtb25nb01hcFtrZXldLnBhdGhzKTtcclxuICAgICB2YXIgcmVzID0gW107XHJcbiAgICAgdmFyIHNlZW5BY2Nlc3MgPSB7fSBhcyB7IFtrZXk6c3RyaW5nXSA6IGJvb2xlYW59O1xyXG4gICAgIHJldHVybiBwYXRocy5yZWR1Y2UoIChwcmV2LCBwYXRoKSA9PiB7XHJcbiAgICAgICAgdmFyIHByZWZpeCA9ICcnO1xyXG4gICAgICAgIHJldHVybiBwYXRoLnJlZHVjZSggKHByZXYsIHNlZ21lbnQsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIGlmKHBhdGgubGVuZ3RoIC0gMSAgIT09IGluZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAvLyBsYXN0IHNlZ21lbnQgbmV2ZXIgb2YgaW50ZXJlc3QsIGV2ZW4gaWYgW11cclxuICAgICAgICAgICAgICAgIGlmKHNlZ21lbnQgPT09J1tdJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBleHBhbmRQYXRoID0gY29uc3RydWN0UGF0aChwYXRoLGluZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICBpZighc2VlbkFjY2Vzc1tleHBhbmRQYXRoXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWVuQWNjZXNzW2V4cGFuZFBhdGhdID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJldi5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICR1bndpbmQgOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aCA6IGV4cGFuZFBhdGgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlc2VydmVOdWxsQW5kRW1wdHlBcnJheXMgOiB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBwcmV2O1xyXG4gICAgICAgIH0sIHByZXYpO1xyXG4gICAgIH0sIHJlcyk7XHJcbiB9XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWFrZU1vbmdvTWFwKG9Eb2MgOiBJTWF0Y2guSU1vZGVsRG9jLCBlU2NoZW1hIDogSVNjaGVtYS5JRXh0ZW5kZWRTY2hlbWEgKSA6IElNYXRjaC5DYXRNb25nb01hcCB7XHJcbiAgICB2YXIgb01vbmdvTWFwID0ge30gYXMgQ2F0TW9uZ29NYXA7XHJcbiAgICBkZWJ1Z2xvZyggKCkgPT4gJ2NyZWF0aW5nIG1vbmdvbWFwIGZvciAnICsgSlNPTi5zdHJpbmdpZnkoZVNjaGVtYS5tb2RlbG5hbWUsIHVuZGVmaW5lZCwgMikgKyAnIGFuZCAnICsgb0RvYy5tb2RlbG5hbWUgKTtcclxuICAgIGRlYnVnbG9nKCAoKSA9PidjcmVhdGluZyBtb25nb21hcCBmb3IgZG9jICcgKyBKU09OLnN0cmluZ2lmeShvRG9jLCB1bmRlZmluZWQsIDIpKTtcclxuICAgIGRlYnVnbG9nKCAoKSA9Pidjb2xsZXRpbmcgZnJvbSBlU2NoZW1hLnByb3BzJyArIEpTT04uc3RyaW5naWZ5KGVTY2hlbWEucHJvcHMsdW5kZWZpbmVkLDIpKTtcclxuICAgIHZhciByZXMgPSBjb2xsZWN0Q2F0ZWdvcmllcyhlU2NoZW1hLnByb3BzKTtcclxuICAgIG9Eb2MuX2NhdGVnb3JpZXMuZm9yRWFjaChjYXQgPT4ge1xyXG4gICAgICAgIC8vIGNyb3NzIGNoZWNrXHJcbiAgICAgICAgaWYoIXJlc1tjYXQuY2F0ZWdvcnldKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdoZXJlIHByZXNlbnQga2V5cycgKyBPYmplY3Qua2V5cyhyZXMpLnNvcnQoKS5qb2luKFwiOyBcIikpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgY2F0ZWdvcnkgJHtjYXQuY2F0ZWdvcnl9IGlzIG5vdCBpbiBlU2NoZW1hYCk7IC8vICsgSlNPTi5zdHJpbmdpZnkoZVNjaGVtYSx1bmRlZmluZWQsMilcclxuICAgICAgICAgICAgY29uc29sZS5sb2coYGRvY3VtZW50IGhhcyBgKyBvRG9jLl9jYXRlZ29yaWVzLm1hcChjYXQgPT4gY2F0LmNhdGVnb3J5KS5qb2luKCc7ICcpKTtcclxuLy9wcm9jZXNzLmV4aXQoLTEpO1xyXG4gICAgICAgICAgIGNvbnNvbGUubG9nKGBjYXRlZ29yeSBcIiR7Y2F0LmNhdGVnb3J5fVwiIGlzIG5vdCBpbiBlU2NoZW1hIGZvciAke29Eb2MubW9kZWxuYW1lfSArICR7ZVNjaGVtYS5tb2RlbG5hbWV9IDogYFxyXG4gICAgICAgICAgICArIFwiPT09PT1TY2hlbWE6XFxuXCIrIEpTT04uc3RyaW5naWZ5KGVTY2hlbWEsdW5kZWZpbmVkLDIpLnN1YnN0cmluZygwLDQwMClcclxuICAgICAgICAgICAgKyBcIlxcbj09PT09PT09b0RvYzogXFxuXCIgKyBKU09OLnN0cmluZ2lmeShvRG9jLHVuZGVmaW5lZCwyKS5zdWJzdHJpbmcoMCw0MDApKTtcclxuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBjYXRlZ29yeSAke2NhdC5jYXRlZ29yeX0gaXMgbm90IGluIGVTY2hlbWEgZm9yICR7b0RvYy5tb2RlbG5hbWV9ICsgJHtlU2NoZW1hLm1vZGVsbmFtZX0gOiBgXHJcbiAgICAgICAgICAgICsgSlNPTi5zdHJpbmdpZnkoZVNjaGVtYSx1bmRlZmluZWQsMikuc3Vic3RyaW5nKDAsMjAwKVxyXG4gICAgICAgICAgICArIFwiXFxuPT09PT09PT09PT0gXCIgKyBKU09OLnN0cmluZ2lmeShvRG9jLHVuZGVmaW5lZCwyKS5zdWJzdHJpbmcoMCw0MDApKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiByZXM7XHJcbn1cclxuXHJcbiJdfQ==
