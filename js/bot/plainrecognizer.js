"use strict";
/**
 * @copyright (c) 2016 Gerd Forstmann
 * @file plainrecognizer.ts
 *
 * A recognizer parametrized by regex expressions
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.RegExpRecognizer = exports.recognizeText = exports.checkForLength = exports.countCompactWords = exports.compactQuoted = exports.normalizeWhitespace = exports.trimTrailingSentenceDelimiters = exports.matchRegularExpression = exports.extractArgsMap = exports.trimValueAdjusting = exports.parseRules = exports.parseRule = exports.parseRuleArray = exports.parseRuleString = exports.countParenGroups = exports.recognize = void 0;
const debug = require("debug");
const debuglog = debug('plainrecognizer');
const AnyObject = Object;
function recognize(sString, mRules) {
    var res = undefined;
    mRules.every(function (oRule) {
        res = matchRegularExpression(sString, oRule);
        return !res;
    });
    return res;
}
exports.recognize = recognize;
function countParenGroups(s) {
    var res = 0;
    for (var i = 0; i < s.length; ++i) {
        if (s.charAt(i) === '(') {
            ++res;
        }
    }
    return res;
}
exports.countParenGroups = countParenGroups;
/**
 * given a string, e.g.
 * "who is the <category> of <A1>",
 * @param {string} a
 * @returns {IMatch.IRule} a regexp rule
 */
function parseRuleString(a) {
    var s = "^" + a + "$";
    var argMaps = {};
    var m = undefined;
    while (m = /<([^>]+)>([?]?)/.exec(s)) {
        var cat = m[1];
        var greedy = m[2];
        var pos = 1 + countParenGroups(s.substring(0, m.index));
        if (greedy) {
            s = s.replace("<" + cat + ">?", "(.*?)");
        }
        else {
            s = s.replace("<" + cat + ">", "(.*)");
        }
        if (argMaps[cat]) {
            throw Error("Model error duplicate entry!");
        }
        argMaps[cat] = pos;
    }
    return {
        type: 1,
        regexp: new RegExp(s, "i"),
        argsMap: argMaps
    };
}
exports.parseRuleString = parseRuleString;
/**
 * given a string, e.g.
 * "who is the <category> of <A1>",
 * @param {string} a
 * @returns {IMatch.IRule} a regexp rule
 */
function parseRuleArray(a) {
    var s = "^" + a + "$";
    var r = a[0];
    if (typeof a[0] === "string") {
        r = new RegExp(a[0], "i");
    }
    if (!(r instanceof RegExp)) {
        throw Error("illegal state" + JSON.stringify(a));
    }
    return {
        type: 1,
        regexp: r,
        argsMap: a[1]
    };
}
exports.parseRuleArray = parseRuleArray;
function parseRule(a) {
    if (typeof a === 'string') {
        return parseRuleString(a);
    }
    else if (Array.isArray(a)) {
        return parseRuleArray(a);
    }
    throw new Error("unknown rule definition");
}
exports.parseRule = parseRule;
function parseRules(oJSON) {
    var res = {};
    Object.keys(oJSON).forEach(function (sKey) {
        res[sKey] = oJSON[sKey].map(function (oRule) {
            return parseRule(oRule);
        });
    });
    return res;
}
exports.parseRules = parseRules;
;
function trimValueAdjusting(value) {
    var res = { deltaStart: 0, value: value };
    var m = value.match(/^\s+/);
    if (m) {
        res.deltaStart = m[0].length;
        value = value.substr(res.deltaStart);
    }
    m = value.match(/\s+$/);
    if (m) {
        value = value.substr(0, value.length - m[0].length);
    }
    res.value = value;
    return res;
}
exports.trimValueAdjusting = trimValueAdjusting;
function extractArgsMap(s, match, argsMap) {
    if (!argsMap) {
        return [];
    }
    var result = [];
    Object.keys(argsMap).forEach(function (sKey) {
        var res = {};
        var index = argsMap[sKey];
        var value = match[index];
        if ((typeof value === "string") && value.length > 0) {
            res.type = sKey;
            res.entity = value;
            res.startIndex = s.indexOf(value); // this may not be precise
            var trimAdjust = trimValueAdjusting(value);
            res.startIndex += trimAdjust.deltaStart;
            res.entity = trimAdjust.value;
            res.endIndex = res.startIndex + trimAdjust.value.length;
            //res[sKey] = value
            result.push(res);
        }
    });
    return result;
}
exports.extractArgsMap = extractArgsMap;
function matchRegularExpression(text, oRule) {
    debuglog("regexp is " + oRule.regexp.toString());
    debuglog(" text is " + text);
    var m = oRule.regexp.exec(text);
    if (!m) {
        return undefined;
    }
    var res = {};
    res.entities = extractArgsMap(text, m, oRule.argsMap);
    res.score = 0.9;
    debuglog("match " + JSON.stringify(m));
    debuglog('Found one' + JSON.stringify(res, undefined, 2));
    return res;
}
exports.matchRegularExpression = matchRegularExpression;
function trimTrailingSentenceDelimiters(text) {
    var m = /([!.;, ?]|\s)+$/.exec(text);
    if (m) {
        text = text.substr(0, text.length - m[0].length);
    }
    return text;
}
exports.trimTrailingSentenceDelimiters = trimTrailingSentenceDelimiters;
function normalizeWhitespace(text) {
    text = text.replace(/\s+/g, ' ');
    return text;
}
exports.normalizeWhitespace = normalizeWhitespace;
/**
 * Givena string, replace all "....."  with <word>
 */
function compactQuoted(text) {
    text = text.replace(/"[^"]+"/g, "<word>");
    return text;
}
exports.compactQuoted = compactQuoted;
function countCompactWords(text) {
    text = text.replace(/,/g, ' ');
    text = text.replace(/ \s+/g, ' ');
    return text.split(" ").length;
}
exports.countCompactWords = countCompactWords;
function checkForLength(text) {
    var textStripped = trimTrailingSentenceDelimiters(text);
    if ((textStripped.length > 200) || (countCompactWords(compactQuoted(text)) > 20)) {
        return {
            intent: "TooLong",
            score: 1.0,
            entities: []
        };
    }
    return undefined;
}
exports.checkForLength = checkForLength;
function recognizeText(text, aRules) {
    var res = undefined;
    aRules.every(function (oRule) {
        res = matchRegularExpression(text, oRule);
        return !res;
    });
    return res;
}
exports.recognizeText = recognizeText;
class RegExpRecognizer {
    constructor(xRules) {
        this.oRules = xRules;
        debuglog("rules " + JSON.stringify(this.oRules));
    }
    ;
    recognize(context, callback) {
        var u = {};
        context.message.text = context.message.text || '';
        var text = context.message.text;
        var that = this;
        var r = checkForLength(text);
        if (r) {
            callback(undefined, r);
            return;
        }
        debuglog("rules " + JSON.stringify(this.oRules));
        var text = trimTrailingSentenceDelimiters(text);
        var results = Object.keys(this.oRules).map(function (sKey) {
            var u = recognizeText(text, that.oRules[sKey]);
            if (u) {
                u.intent = sKey;
            }
            return u ? u : undefined;
        }).filter(function (o) { return !!o; });
        if (results.length > 1) {
            /* TODO abiguous */
            debuglog("ambiguous result for >" + text + "<" + JSON.stringify(res));
        }
        if (results.length > 0) {
            var res = results[0];
            callback(undefined, res);
            return;
        }
        debuglog('recognizing nothing');
        u.intent = "None";
        u.score = 0.1;
        var e1 = {};
        e1.startIndex = "exit ".length;
        e1.endIndex = context.message.text.length;
        e1.score = 0.1;
        u.entities = [];
        callback(undefined, u);
    }
} // class
exports.RegExpRecognizer = RegExpRecognizer;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ib3QvcGxhaW5yZWNvZ25pemVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQTs7Ozs7R0FLRzs7O0FBSUgsK0JBQStCO0FBQy9CLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBRTFDLE1BQU0sU0FBUyxHQUFHLE1BQWEsQ0FBQztBQUVoQyxTQUFnQixTQUFTLENBQUMsT0FBTyxFQUFFLE1BQWdDO0lBQ2pFLElBQUksR0FBRyxHQUFHLFNBQVMsQ0FBQztJQUNwQixNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsS0FBSztRQUMxQixHQUFHLEdBQUcsc0JBQXNCLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzdDLE9BQU8sQ0FBQyxHQUFHLENBQUM7SUFDZCxDQUFDLENBQUMsQ0FBQTtJQUNGLE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQVBELDhCQU9DO0FBRUQsU0FBZ0IsZ0JBQWdCLENBQUMsQ0FBUztJQUN4QyxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFDWixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRTtRQUNqQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQ3ZCLEVBQUUsR0FBRyxDQUFDO1NBQ1A7S0FDRjtJQUNELE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQVJELDRDQVFDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFnQixlQUFlLENBQUMsQ0FBUztJQUN2QyxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQztJQUN0QixJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7SUFDakIsSUFBSSxDQUFDLEdBQUcsU0FBUyxDQUFDO0lBQ2xCLE9BQU8sQ0FBQyxHQUFHLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFD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QUMsRUFBRTtZQUN0QixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckIsUUFBUSxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUN6QixPQUFPO1NBQ1I7UUFDRCxRQUFRLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUNoQyxDQUFDLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNsQixDQUFDLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQztRQUNkLElBQUksRUFBRSxHQUFHLEVBQXFCLENBQUM7UUFDL0IsRUFBRSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQy9CLEVBQUUsQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQzFDLEVBQUUsQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDO1FBQ2YsQ0FBQyxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDaEIsUUFBUSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN6QixDQUFDO0NBQ0YsQ0FBQyxRQUFRO0FBaERWLDRDQWdEQyIsImZpbGUiOiJib3QvcGxhaW5yZWNvZ25pemVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG4vKipcbiAqIEBjb3B5cmlnaHQgKGMpIDIwMTYgR2VyZCBGb3JzdG1hbm5cbiAqIEBmaWxlIHBsYWlucmVjb2duaXplci50c1xuICpcbiAqIEEgcmVjb2duaXplciBwYXJhbWV0cml6ZWQgYnkgcmVnZXggZXhwcmVzc2lvbnNcbiAqL1xuXG5pbXBvcnQgKiBhcyBidWlsZGVyIGZyb20gJ2JvdGJ1aWxkZXInO1xuaW1wb3J0ICogYXMgSU1hdGNoIGZyb20gJy4uL21hdGNoL2lmbWF0Y2gnO1xuaW1wb3J0ICogYXMgZGVidWcgZnJvbSAnZGVidWcnO1xuY29uc3QgZGVidWdsb2cgPSBkZWJ1ZygncGxhaW5yZWNvZ25pemVyJyk7XG5cbmNvbnN0IEFueU9iamVjdCA9IE9iamVjdCBhcyBhbnk7XG5cbmV4cG9ydCBmdW5jdGlvbiByZWNvZ25pemUoc1N0cmluZywgbVJ1bGVzOiBBcnJheTxJTWF0Y2guSW50ZW50UnVsZT4pIHtcbiAgdmFyIHJlcyA9IHVuZGVmaW5lZDtcbiAgbVJ1bGVzLmV2ZXJ5KGZ1bmN0aW9uIChvUnVsZSkge1xuICAgIHJlcyA9IG1hdGNoUmVndWxhckV4cHJlc3Npb24oc1N0cmluZywgb1J1bGUpO1xuICAgIHJldHVybiAhcmVzO1xuICB9KVxuICByZXR1cm4gcmVzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY291bnRQYXJlbkdyb3VwcyhzOiBzdHJpbmcpIHtcbiAgdmFyIHJlcyA9IDA7XG4gIGZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7ICsraSkge1xuICAgIGlmIChzLmNoYXJBdChpKSA9PT0gJygnKSB7XG4gICAgICArK3JlcztcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlcztcbn1cblxuLyoqXG4gKiBnaXZlbiBhIHN0cmluZywgZS5nLlxuICogXCJ3aG8gaXMgdGhlIDxjYXRlZ29yeT4gb2YgPEExPlwiLFxuICogQHBhcmFtIHtzdHJpbmd9IGFcbiAqIEByZXR1cm5zIHtJTWF0Y2guSVJ1bGV9IGEgcmVnZXhwIHJ1bGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlUnVsZVN0cmluZyhhOiBzdHJpbmcpOiBJTWF0Y2guSW50ZW50UnVsZSB7XG4gIHZhciBzID0gXCJeXCIgKyBhICsgXCIkXCI7XG4gIHZhciBhcmdNYXBzID0ge307XG4gIHZhciBtID0gdW5kZWZpbmVkO1xuICB3aGlsZSAobSA9IC88KFtePl0rKT4oWz9dPykvLmV4ZWMocykpIHtcbiAgICB2YXIgY2F0ID0gbVsxXTtcbiAgICB2YXIgZ3JlZWR5ID0gbVsyXTtcbiAgICB2YXIgcG9zID0gMSArIGNvdW50UGFyZW5Hcm91cHMocy5zdWJzdHJpbmcoMCwgbS5pbmRleCkpO1xuICAgIGlmKGdyZWVkeSkge1xuICAgICAgcyA9IHMucmVwbGFjZShcIjxcIiArIGNhdCArIFwiPj9cIiwgXCIoLio/KVwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBzID0gcy5yZXBsYWNlKFwiPFwiICsgY2F0ICsgXCI+XCIsIFwiKC4qKVwiKTtcbiAgICAgIH1cbiAgICBpZiAoYXJnTWFwc1tjYXRdKSB7XG4gICAgICB0aHJvdyBFcnJvcihcIk1vZGVsIGVycm9yIGR1cGxpY2F0ZSBlbnRyeSFcIilcbiAgICB9XG4gICAgYXJnTWFwc1tjYXRdID0gcG9zO1xuICB9XG4gIHJldHVybiB7XG4gICAgdHlwZTogMSxcbiAgICByZWdleHA6IG5ldyBSZWdFeHAocywgXCJpXCIpLFxuICAgIGFyZ3NNYXA6IGFyZ01hcHNcbiAgfTtcbn1cblxuXG4vKipcbiAqIGdpdmVuIGEgc3RyaW5nLCBlLmcuXG4gKiBcIndobyBpcyB0aGUgPGNhdGVnb3J5PiBvZiA8QTE+XCIsXG4gKiBAcGFyYW0ge3N0cmluZ30gYVxuICogQHJldHVybnMge0lNYXRjaC5JUnVsZX0gYSByZWdleHAgcnVsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VSdWxlQXJyYXkoYTogQXJyYXk8YW55Pik6IElNYXRjaC5JbnRlbnRSdWxlIHtcbiAgdmFyIHMgPSBcIl5cIiArIGEgKyBcIiRcIjtcbiAgdmFyIHIgPSBhWzBdO1xuICBpZih0eXBlb2YgYVswXSA9PT0gXCJzdHJpbmdcIikge1xuICAgIHIgPSBuZXcgUmVnRXhwKGFbMF0sXCJpXCIpO1xuICB9XG4gIGlmICghKHIgaW5zdGFuY2VvZiBSZWdFeHApKSB7XG4gICAgdGhyb3cgRXJyb3IoXCJpbGxlZ2FsIHN0YXRlXCIgKyBKU09OLnN0cmluZ2lmeShhKSk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAxLFxuICAgIHJlZ2V4cDogcixcbiAgICBhcmdzTWFwOiBhWzFdXG4gIH07XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlUnVsZShhOiBhbnkpOiBJTWF0Y2guSW50ZW50UnVsZSB7XG4gIGlmICh0eXBlb2YgYSA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gcGFyc2VSdWxlU3RyaW5nKGEpO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoYSkpIHtcbiAgICByZXR1cm4gcGFyc2VSdWxlQXJyYXkoYSk7XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKFwidW5rbm93biBydWxlIGRlZmluaXRpb25cIik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVJ1bGVzKG9KU09OOiB7IFtrZXk6IHN0cmluZ106IGFueSB9KTogeyBba2V5OiBzdHJpbmddOiBBcnJheTxJTWF0Y2guSW50ZW50UnVsZT4gfSB7XG4gIHZhciByZXMgPSB7fTtcbiAgT2JqZWN0LmtleXMob0pTT04pLmZvckVhY2goZnVuY3Rpb24gKHNLZXkpIHtcbiAgICByZXNbc0tleV0gPSBvSlNPTltzS2V5XS5tYXAoZnVuY3Rpb24gKG9SdWxlKSB7XG4gICAgICByZXR1cm4gcGFyc2VSdWxlKG9SdWxlKTtcbiAgICB9KVxuICB9KTtcbiAgcmV0dXJuIHJlcztcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiB0cmltVmFsdWVBZGp1c3RpbmcodmFsdWUgOiBzdHJpbmcpIDogeyBkZWx0YVN0YXJ0IDpudW1iZXIsIHZhbHVlIDogc3RyaW5nfSB7XG4gIHZhciByZXMgPSB7IGRlbHRhU3RhcnQgOiAwLCB2YWx1ZSA6IHZhbHVlIH07XG4gIHZhciBtID0gdmFsdWUubWF0Y2goL15cXHMrLyk7XG4gIGlmKG0pIHtcbiAgICByZXMuZGVsdGFTdGFydCA9IG1bMF0ubGVuZ3RoO1xuICAgIHZhbHVlID0gdmFsdWUuc3Vic3RyKHJlcy5kZWx0YVN0YXJ0KTtcbiAgfVxuICBtID0gdmFsdWUubWF0Y2goL1xccyskLyk7XG4gIGlmKG0pIHtcbiAgICB2YWx1ZSA9IHZhbHVlLnN1YnN0cigwLCB2YWx1ZS5sZW5ndGggLSBtWzBdLmxlbmd0aCk7XG4gIH1cbiAgcmVzLnZhbHVlID0gdmFsdWU7XG4gIHJldHVybiByZXM7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4dHJhY3RBcmdzTWFwKHMgOiBzdHJpbmcsIG1hdGNoOiBBcnJheTxzdHJpbmc+LCBhcmdzTWFwOiB7IFtrZXk6IHN0cmluZ106IG51bWJlciB9KTogQXJyYXk8YnVpbGRlci5JRW50aXR5PiB7XG4gIGlmICghYXJnc01hcCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuICB2YXIgcmVzdWx0ID0gW107XG4gIE9iamVjdC5rZXlzKGFyZ3NNYXApLmZvckVhY2goZnVuY3Rpb24gKHNLZXkpIHtcbiAgICB2YXIgcmVzID0ge30gYXMgYnVpbGRlci5JRW50aXR5O1xuICAgIHZhciBpbmRleCA9IGFyZ3NNYXBbc0tleV07XG4gICAgdmFyIHZhbHVlID0gbWF0Y2hbaW5kZXhdXG4gICAgaWYgKCh0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIpICYmIHZhbHVlLmxlbmd0aCA+IDApIHtcbiAgICAgIHJlcy50eXBlID0gc0tleTtcbiAgICAgIHJlcy5lbnRpdHkgPSB2YWx1ZTtcbiAgICAgIHJlcy5zdGFydEluZGV4ID0gcy5pbmRleE9mKHZhbHVlKTsgLy8gdGhpcyBtYXkgbm90IGJlIHByZWNpc2VcbiAgICAgIHZhciB0cmltQWRqdXN0ID0gdHJpbVZhbHVlQWRqdXN0aW5nKHZhbHVlKTtcbiAgICAgIHJlcy5zdGFydEluZGV4ICs9IHRyaW1BZGp1c3QuZGVsdGFTdGFydDtcbiAgICAgIHJlcy5lbnRpdHkgPSB0cmltQWRqdXN0LnZhbHVlO1xuICAgICAgcmVzLmVuZEluZGV4ID0gcmVzLnN0YXJ0SW5kZXggKyB0cmltQWRqdXN0LnZhbHVlLmxlbmd0aDtcbiAgICAgIC8vcmVzW3NLZXldID0gdmFsdWVcbiAgICAgIHJlc3VsdC5wdXNoKHJlcyk7XG4gICAgfVxuICB9XG4gICk7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYXRjaFJlZ3VsYXJFeHByZXNzaW9uKHRleHQgOiBzdHJpbmcsIG9SdWxlIDogSU1hdGNoLkludGVudFJ1bGUpIDogYnVpbGRlci5JSW50ZW50UmVjb2duaXplclJlc3VsdCB7XG4gIGRlYnVnbG9nKFwicmVnZXhwIGlzIFwiICsgb1J1bGUucmVnZXhwLnRvU3RyaW5nKCkpO1xuICBkZWJ1Z2xvZyhcIiB0ZXh0IGlzIFwiICsgdGV4dCk7XG4gIHZhciBtID0gb1J1bGUucmVnZXhwLmV4ZWModGV4dCk7XG4gIGlmICghbSkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgdmFyIHJlcyA9IHt9IGFzIGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXJSZXN1bHQ7XG4gIHJlcy5lbnRpdGllcyA9IGV4dHJhY3RBcmdzTWFwKHRleHQsIG0sIG9SdWxlLmFyZ3NNYXApO1xuICByZXMuc2NvcmUgPSAwLjk7XG4gIGRlYnVnbG9nKFwibWF0Y2ggXCIgKyBKU09OLnN0cmluZ2lmeShtKSk7XG4gIGRlYnVnbG9nKCdGb3VuZCBvbmUnICsgSlNPTi5zdHJpbmdpZnkocmVzLCB1bmRlZmluZWQsIDIpKTtcbiAgcmV0dXJuIHJlcztcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gdHJpbVRyYWlsaW5nU2VudGVuY2VEZWxpbWl0ZXJzKHRleHQgOiBzdHJpbmcpIDogc3RyaW5nIHtcbiAgdmFyIG0gPSAvKFshLjssID9dfFxccykrJC8uZXhlYyh0ZXh0KTtcbiAgaWYgKG0pIHtcbiAgICB0ZXh0ID0gdGV4dC5zdWJzdHIoMCx0ZXh0Lmxlbmd0aC0gbVswXS5sZW5ndGgpO1xuICB9XG4gIHJldHVybiB0ZXh0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbm9ybWFsaXplV2hpdGVzcGFjZSh0ZXh0IDogc3RyaW5nKSA6IHN0cmluZyB7XG4gIHRleHQgPSB0ZXh0LnJlcGxhY2UoL1xccysvZywnICcpO1xuICByZXR1cm4gdGV4dDtcbn1cblxuLyoqXG4gKiBHaXZlbmEgc3RyaW5nLCByZXBsYWNlIGFsbCBcIi4uLi4uXCIgIHdpdGggPHdvcmQ+XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb21wYWN0UXVvdGVkKHRleHQ6IHN0cmluZykgOiBzdHJpbmcge1xuICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9cIlteXCJdK1wiL2csIFwiPHdvcmQ+XCIpO1xuICByZXR1cm4gdGV4dDtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gY291bnRDb21wYWN0V29yZHModGV4dDogc3RyaW5nKSA6IG51bWJlciB7XG4gIHRleHQgPSB0ZXh0LnJlcGxhY2UoLywvZywgJyAnKTtcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvIFxccysvZywgJyAnKTtcbiAgcmV0dXJuIHRleHQuc3BsaXQoXCIgXCIpLmxlbmd0aDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNoZWNrRm9yTGVuZ3RoKHRleHQpIDogYnVpbGRlci5JSW50ZW50UmVjb2duaXplclJlc3VsdCB7XG4gICAgdmFyIHRleHRTdHJpcHBlZCA9IHRyaW1UcmFpbGluZ1NlbnRlbmNlRGVsaW1pdGVycyh0ZXh0KTtcbiAgICBpZigodGV4dFN0cmlwcGVkLmxlbmd0aCA+IDIwMCkgfHwgKGNvdW50Q29tcGFjdFdvcmRzKGNvbXBhY3RRdW90ZWQodGV4dCkpID4gMjApKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpbnRlbnQ6IFwiVG9vTG9uZ1wiLFxuICAgICAgICBzY29yZSA6IDEuMCxcbiAgICAgICAgZW50aXRpZXMgOiBbXVxuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlY29nbml6ZVRleHQodGV4dCA6IHN0cmluZywgYVJ1bGVzIDogQXJyYXk8SU1hdGNoLkludGVudFJ1bGU+KSA6IGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXJSZXN1bHR7XG4gICAgdmFyIHJlcyA9IHVuZGVmaW5lZDtcbiAgICBhUnVsZXMuZXZlcnkoZnVuY3Rpb24gKG9SdWxlKSB7XG4gICAgICAgIHJlcyA9IG1hdGNoUmVndWxhckV4cHJlc3Npb24odGV4dCwgb1J1bGUpO1xuICAgICAgICByZXR1cm4gIXJlcztcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzO1xufVxuXG5leHBvcnQgY2xhc3MgUmVnRXhwUmVjb2duaXplciBpbXBsZW1lbnRzIGJ1aWxkZXIuSUludGVudFJlY29nbml6ZXIge1xuICBvUnVsZXM6IHsgW2tleTogc3RyaW5nXTogQXJyYXk8SU1hdGNoLkludGVudFJ1bGU+IH07XG5cbiAgY29uc3RydWN0b3IoeFJ1bGVzOiB7IFtrZXk6IHN0cmluZ106IEFycmF5PElNYXRjaC5JbnRlbnRSdWxlPiB9KSB7XG4gICAgdGhpcy5vUnVsZXMgPSB4UnVsZXM7XG4gICAgZGVidWdsb2coXCJydWxlcyBcIiArIEpTT04uc3RyaW5naWZ5KHRoaXMub1J1bGVzKSk7XG4gIH07XG5cbiAgcmVjb2duaXplKGNvbnRleHQ6IGJ1aWxkZXIuSVJlY29nbml6ZUNvbnRleHQsIGNhbGxiYWNrOiAoZXJyOiBFcnJvciwgcmVzdWx0OiBidWlsZGVyLklJbnRlbnRSZWNvZ25pemVyUmVzdWx0KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdmFyIHUgPSB7fSBhcyBidWlsZGVyLklJbnRlbnRSZWNvZ25pemVyUmVzdWx0O1xuICAgIGNvbnRleHQubWVzc2FnZS50ZXh0ID0gY29udGV4dC5tZXNzYWdlLnRleHQgfHwgJyc7XG4gICAgdmFyIHRleHQgPSBjb250ZXh0Lm1lc3NhZ2UudGV4dDtcbiAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgdmFyIHIgPSBjaGVja0Zvckxlbmd0aCh0ZXh0KTtcbiAgICBpZihyKSB7XG4gICAgICBjYWxsYmFjayh1bmRlZmluZWQscik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGRlYnVnbG9nKFwicnVsZXMgXCIgKyBKU09OLnN0cmluZ2lmeSh0aGlzLm9SdWxlcykpO1xuXG4gICAgdmFyIHRleHQgPSB0cmltVHJhaWxpbmdTZW50ZW5jZURlbGltaXRlcnModGV4dCk7XG5cbiAgICB2YXIgcmVzdWx0cyA9IE9iamVjdC5rZXlzKHRoaXMub1J1bGVzKS5tYXAoZnVuY3Rpb24gKHNLZXkpIHtcbiAgICAgIHZhciB1ID0gcmVjb2duaXplVGV4dCh0ZXh0LCB0aGF0Lm9SdWxlc1tzS2V5XSk7XG4gICAgICBpZiAodSkge1xuICAgICAgICB1LmludGVudCA9IHNLZXk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdSA/ICB1IDogdW5kZWZpbmVkO1xuICAgIH0pLmZpbHRlcihmdW5jdGlvbiAobykgeyByZXR1cm4gISFvOyB9KTtcbiAgICBpZiAocmVzdWx0cy5sZW5ndGggPiAxKSB7XG4gICAgICAvKiBUT0RPIGFiaWd1b3VzICovXG4gICAgICBkZWJ1Z2xvZyhcImFtYmlndW91cyByZXN1bHQgZm9yID5cIiArIHRleHQgKyBcIjxcIiArIEpTT04uc3RyaW5naWZ5KHJlcykpO1xuICAgIH1cbiAgICBpZiAocmVzdWx0cy5sZW5ndGggPiAwKSB7XG4gICAgICB2YXIgcmVzID0gcmVzdWx0c1swXTtcbiAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgcmVzKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZGVidWdsb2coJ3JlY29nbml6aW5nIG5vdGhpbmcnKTtcbiAgICB1LmludGVudCA9IFwiTm9uZVwiO1xuICAgIHUuc2NvcmUgPSAwLjE7XG4gICAgdmFyIGUxID0ge30gYXMgYnVpbGRlci5JRW50aXR5O1xuICAgIGUxLnN0YXJ0SW5kZXggPSBcImV4aXQgXCIubGVuZ3RoO1xuICAgIGUxLmVuZEluZGV4ID0gY29udGV4dC5tZXNzYWdlLnRleHQubGVuZ3RoO1xuICAgIGUxLnNjb3JlID0gMC4xO1xuICAgIHUuZW50aXRpZXMgPSBbXTtcbiAgICBjYWxsYmFjayh1bmRlZmluZWQsIHUpO1xuICB9XG59IC8vIGNsYXNzXG5cblxuXG4iXX0=
