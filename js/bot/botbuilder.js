"use strict";
/**
 * this emulates the Microsoft BotBuilder SDK V3.
 */
/**
 * @file
 * @module jfseb.nlq_abot.botbuilder
 * @copyright (c) 2016-2109 Gerd Forstmann
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConsoleConnector = exports.IntentDialog = exports.UniversalBot = exports.Prompts = exports.Message = exports.EntityRecognizer = void 0;
class EntityRecognizer {
    static findEntity(entities, type) {
        debugger;
        for (let en of entities) {
            if (en.type == type) {
                return en;
            }
        }
        return undefined;
    }
}
exports.EntityRecognizer = EntityRecognizer;
;
class Message {
    constructor(s) {
        this._theMsg = {
            type: "message",
        };
    }
    toMessage() {
        return this._theMsg;
    }
    ;
    address(adr) {
        this._theMsg.address = adr;
        return this;
    }
    text(txt) {
        this._theMsg.text = txt;
        return this;
    }
    timestamp() {
        this._theMsg.timestamp = new Date().toISOString();
        return this;
    }
    addEntity(o) {
        if (!this._theMsg.entities) {
            this._theMsg.entities = [];
        }
        this._theMsg.entities.push(o);
        return this;
    }
}
exports.Message = Message;
class Prompts {
    static text(session, a) {
    }
}
exports.Prompts = Prompts;
class UniversalBot {
    constructor(connector) {
        this._dialogs = new Map();
        this._connector = connector;
        this._connector.onEvent(this._onEvent.bind(this));
        return this;
    }
    // connector calls handler -> 
    // after analysis we whall call _connector.send(messages, done() ) with result in messages .text 
    _onEvent(msgs) {
        // run messages through all dialogs 
        var self = this;
        this._dialogs.forEach((id, key) => {
            msgs.forEach(msg => id._processMessage(msg, self._connector));
        });
    }
    dialog(path, dialog) {
        this._dialogs.set(path, dialog);
    }
}
exports.UniversalBot = UniversalBot;
class IntentDialog {
    constructor(a) {
        this._matches = new Map();
        this._recognizers = a;
    }
    _processMessage(msg, connector) {
        var Bfound = { found: false };
        var session;
        session = {
            message: msg,
            send(response) {
                if (typeof response == "string") {
                    connector.send([{ text: response }], (a) => { });
                }
                else {
                    connector.send([response.toMessage()], (a) => { });
                }
            }
        };
        this._recognizers.recognizers.forEach((ir) => {
            var irc;
            irc = { message: msg };
            ir.recognize(irc, (err, result) => {
                var intent = result.intent;
                if (result.score > 0.1 && intent !== 'None') {
                    debugger;
                    this._matches.get(intent).forEach(a => a(session, result, () => { }));
                    Bfound.found = true;
                }
            });
        });
        if (!Bfound.found) {
            debugger;
            this._default(session);
        }
    }
    onBegin(cb) {
    }
    onDefault(cb) {
        this._default = cb;
    }
    matches(intent, sess) {
        this._matches.set(intent, sess);
    }
}
exports.IntentDialog = IntentDialog;
const readline = require("readline");
class ConsoleConnector {
    constructor(options) {
        this.processMessage = function (line, id) {
            if (typeof id === 'string') {
                id = {
                    conversationId: id,
                    user: id,
                };
            }
            if (this.handler) {
                var msg = new Message(null)
                    .address(id)
                    .timestamp()
                    .text(line);
                this.handler([msg.toMessage()]);
            }
            return this;
        };
        this.startConversation = function (address, cb) {
            // TODO invoke this at an appropriate time
            var adr = Object.assign({}, address);
            cb(null, adr);
        };
        options = options || {};
        this.stdin = options.stdin || process.stdin;
        this.stdout = options.stdout || process.stdout;
        this.replyCnt = 0;
        this.conversationId = options && options.conversationId || ('' + Date.now());
        return this;
    }
    listen() {
        var self = this;
        var rl = readline.createInterface(this.stdin, this.stdout); // output: this.stdout } );
        this.answerHook = (txt, cmd, conversationId) => {
            console.log(txt);
            if (cmd) {
                console.log("cmd " + JSON.stringify(cmd));
            }
            rl.prompt();
        };
        // forever .... 
        rl.setPrompt(">");
        rl.prompt();
        rl.on('close', () => { process.exit(-1); });
        rl.on('line', (line) => {
            self.processMessage(line, { conversationId: "conv1", user: "nouser" });
        });
        return this;
    }
    setAnswerHook(answerHook, id) {
        if (id) {
            this.answerHooks[id] = answerHook;
        }
        this.answerHook = answerHook;
    }
    ;
    setQuitHook(quitHook) {
        this.quitHook = quitHook;
    }
    ;
    onEvent(handler) {
        this.handler = handler;
    }
    ;
    send(messages, done) {
        for (var i = 0; i < messages.length; i++) {
            if (this.replyCnt++ > 0) {
                //  console.log(' reply ');
            }
            var msg = messages[i];
            if (msg.text) {
                var command = undefined;
                if (msg.entities && msg.entities[0] && msg.entities[0]) {
                    command = msg.entities[0];
                }
                if (msg.address && msg.address.conversationId
                    && this.answerHooks[msg.address.conversationId]) {
                    this.answerHooks[msg.address.conversationId](msg.text, command, msg.address.conversationId);
                }
                else {
                    this.answerHook(msg.text, command, "singletarget");
                }
            }
        }
        done(null);
    }
    ;
}
exports.ConsoleConnector = ConsoleConnector;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ib3QvYm90YnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7QUFDSDs7OztHQUlHOzs7QUFxQkgsTUFBYSxnQkFBZ0I7SUFDM0IsTUFBTSxDQUFDLFVBQVUsQ0FBQyxRQUFtQixFQUFFLElBQVk7UUFDakQsUUFBUSxDQUFDO1FBQ1QsS0FBSSxJQUFJLEVBQUUsSUFBSSxRQUFRLEVBQUU7WUFDdEIsSUFBRyxFQUFFLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRztnQkFDbkIsT0FBTyxFQUFFLENBQUM7YUFDWDtTQUNGO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztDQUNGO0FBVkQsNENBVUM7QUFBQSxDQUFDO0FBNkJGLE1BQWEsT0FBTztJQUVsQixZQUFZLENBQVU7UUFDcEIsSUFBSSxDQUFDLE9BQU8sR0FBRztZQUNiLElBQUksRUFBRyxTQUFTO1NBQ0YsQ0FBQztJQUNuQixDQUFDO0lBQ0QsU0FBUztRQUNQLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN0QixDQUFDO0lBQUEsQ0FBQztJQUNGLE9BQU8sQ0FBQyxHQUFZO1FBQ2xCLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQztRQUMzQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFDRCxJQUFJLENBQUMsR0FBVTtRQUNiLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQztRQUN4QixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFDRCxTQUFTO1FBQ1AsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNsRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFDRCxTQUFTLENBQUMsQ0FBTztRQUNmLElBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRztZQUM1QixJQUFJLENBQUMsT0FBTyxDQUFDLFFB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LElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDekIsMkJBQTJCO2FBQzFCO1lBQ0QsSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLElBQUksR0FBRyxDQUFDLElBQUksRUFBRTtnQkFDWixJQUFJLE9BQU8sR0FBRyxTQUFTLENBQUM7Z0JBQ3hCLElBQUcsR0FBRyxDQUFDLFFBQVEsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUU7b0JBQ3JELE9BQU8sR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUMzQjtnQkFDRCxJQUFJLEdBQUcsQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxjQUFjO3VCQUMxQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEVBQUc7b0JBQ2hELElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBRSxDQUFDO2lCQUM5RjtxQkFBTTtvQkFDTCxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDO2lCQUNwRDthQUNGO1NBQ0Y7UUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDYixDQUFDO0lBQUEsQ0FBQztDQU1IO0FBN0ZELDRDQTZGQyIsImZpbGUiOiJib3QvYm90YnVpbGRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogdGhpcyBlbXVsYXRlcyB0aGUgTWljcm9zb2Z0IEJvdEJ1aWxkZXIgU0RLIFYzLiBcbiAqL1xuLyoqXG4gKiBAZmlsZVxuICogQG1vZHVsZSBqZnNlYi5ubHFfYWJvdC5ib3RidWlsZGVyXG4gKiBAY29weXJpZ2h0IChjKSAyMDE2LTIxMDkgR2VyZCBGb3JzdG1hbm5cbiAqL1xuXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgeyByZW1vdmVMaXN0ZW5lciwgc2VuZCB9IGZyb20gJ3Byb2Nlc3MnO1xuXG5pbnRlcmZhY2UgQm90QnVpbGRlciB7XG5cbn1cblxuZXhwb3J0IGludGVyZmFjZSBCb3Qge1xuICBpZCA6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJRW50aXR5IHtcbiAgc3RhcnRJbmRleCA6IG51bWJlcjtcbiAgZW50aXR5IDogc3RyaW5nO1xuICB0eXBlIDogc3RyaW5nO1xuICBlbmRJbmRleCA6IG51bWJlcjtcbiAgc2NvcmUgOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBFbnRpdHlSZWNvZ25pemVyIHtcbiAgc3RhdGljIGZpbmRFbnRpdHkoZW50aXRpZXM6IElFbnRpdHlbXSwgdHlwZTogc3RyaW5nKSA6IGFueSB7XG4gICAgZGVidWdnZXI7XG4gICAgZm9yKGxldCBlbiBvZiBlbnRpdGllcykge1xuICAgICAgaWYoZW4udHlwZSA9PSB0eXBlICkge1xuICAgICAgICByZXR1cm4gZW47XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJlY29nbml6ZUNvbnRleHQge1xuICBtZXNzYWdlIDogSU1lc3NhZ2U7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUludGVudFJlY29nbml6ZXJSZXN1bHQge1xuICBpbnRlbnQgOiBzdHJpbmc7IFxuICBzY29yZSA6IG51bWJlcjtcbiAgZW50aXRpZXMgOiBJRW50aXR5W107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUludGVudFJlY29nbml6ZXIge1xuICByZWNvZ25pemUoY29udGV4dDogSVJlY29nbml6ZUNvbnRleHQsIGNhbGxiYWNrOiAoZXJyOiBFcnJvciwgcmVzdWx0OiBJSW50ZW50UmVjb2duaXplclJlc3VsdCkgPT4gdm9pZCk6IHZvaWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWRkcmVzcyB7XG4gIGNvbnZlcnNhdGlvbklkOiBzdHJpbmc7XG4gIHVzZXIgOiBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJTWVzc2FnZSB7XG4gIGFkZHJlc3MgOiBBZGRyZXNzO1xuICB0eXBlPzpzdHJpbmc7XG4gIHRleHQgOiBzdHJpbmc7XG4gIHRpbWVzdGFtcCA6IHN0cmluZztcbiAgZW50aXRpZXM/IDogc3RyaW5nW107XG59XG5cbmV4cG9ydCBjbGFzcyBNZXNzYWdlIHtcbiAgX3RoZU1zZyA6IElNZXNzYWdlO1xuICBjb25zdHJ1Y3RvcihzOiBTZXNzaW9uKSB7IFxuICAgIHRoaXMuX3RoZU1zZyA9IHtcbiAgICAgIHR5cGUgOiBcIm1lc3NhZ2VcIixcbiAgICAgICB9IGFzIElNZXNzYWdlO1xuICB9XG4gIHRvTWVzc2FnZSgpIDogSU1lc3NhZ2Uge1xuICAgIHJldHVybiB0aGlzLl90aGVNc2c7IFxuICB9O1xuICBhZGRyZXNzKGFkcjogQWRkcmVzcykgOiBNZXNzYWdlIHtcbiAgICB0aGlzLl90aGVNc2cuYWRkcmVzcyA9IGFkcjtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuICB0ZXh0KHR4dDpzdHJpbmcpIDogTWVzc2FnZSB7XG4gICAgdGhpcy5fdGhlTXNnLnRleHQgPSB0eHQ7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cbiAgdGltZXN0YW1wKCkgOiBNZXNzYWdlIHtcbiAgICB0aGlzLl90aGVNc2cudGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG4gIGFkZEVudGl0eShvIDogYW55KSA6IE1lc3NhZ2Uge1xuICAgIGlmICggIXRoaXMuX3RoZU1zZy5lbnRpdGllcyApIHtcbiAgICAgIHRoaXMuX3RoZU1zZy5lbnRpdGllcyA9IFtdO1xuICAgIH1cbiAgICB0aGlzLl90aGVNc2cuZW50aXRpZXMucHVzaChvKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxufVxuXG50eXBlIHN0cmluZ09yTWVzc2FnZSA9IHN0cmluZyB8IE1lc3NhZ2U7XG5cbmV4cG9ydCBjbGFzcyBQcm9tcHRzIHtcbiAgc3RhdGljIHRleHQoc2Vzc2lvbjogU2Vzc2lvbiwgYTpzdHJpbmcpIDogdm9pZCB7XG4gIH1cbn1cblxuXG4vLyBhdCB0aGUgZW5kIGludm9rZSBzZW5kKG1lc3NhZ2VzLCBkb25lKSBvbiB0aGUgY29ubmVjdG9yIFxuLy8gXG5cbmV4cG9ydCBpbnRlcmZhY2UgRW5kRGlhbG9nQXJnIHtcbiAgcmVzcG9uc2UgOiBhbnk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVXNlckRhdGEge1xuICBjb3VudCA6IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTZXNzaW9uIHtcbiAgbWVzc2FnZSA6IElNZXNzYWdlO1xuICBkaWFsb2dEYXRhIDogYW55O1xuICBzZW5kKGFyZyA6IHN0cmluZ09yTWVzc2FnZSkgOiB2b2lkO1xuICBlbmREaWFsb2dXaXRoUmVzdWx0KCBhcmcgOiBFbmREaWFsb2dBcmcpO1xuICBiZWdpbkRpYWxvZyhtYXRjaDogc3RyaW5nLCBhOiBudW1iZXIpO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDb25uZWN0b3Ige1xuICBvbkV2ZW50KCBmbjogKG1zZ3M6IElNZXNzYWdlW10pID0+IHZvaWQgKSA6IHZvaWQ7IFxuICBzZW5kKG1lc3NhZ2VzOiBJTWVzc2FnZVtdLGZuOiAoYTphbnkpID0+IHZvaWQpO1xufVxuXG5leHBvcnQgY2xhc3MgVW5pdmVyc2FsQm90IHtcbiAgX2RpYWxvZ3MgOiBNYXA8c3RyaW5nLEludGVudERpYWxvZz47IFxuICBfY29ubmVjdG9yIDogSUNvbm5lY3RvcjtcblxuICAvLyBjb25uZWN0b3IgY2FsbHMgaGFuZGxlciAtPiBcbiAgLy8gYWZ0ZXIgYW5hbHlzaXMgd2Ugd2hhbGwgY2FsbCBfY29ubmVjdG9yLnNlbmQobWVzc2FnZXMsIGRvbmUoKSApIHdpdGggcmVzdWx0IGluIG1lc3NhZ2VzIC50ZXh0IFxuXG4gIF9vbkV2ZW50KCBtc2dzOiBJTWVzc2FnZVtdICkgOiB2b2lkIHtcbiAgICAvLyBydW4gbWVzc2FnZXMgdGhyb3VnaCBhbGwgZGlhbG9ncyBcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdGhpcy5fZGlhbG9ncy5mb3JFYWNoKCAoaWQ6SW50ZW50RGlhbG9nLCBrZXk6IHN0cmluZykgPT57XG4gICAgICBtc2dzLmZvckVhY2goIG1zZyA9PiBpZC5fcHJvY2Vzc01lc3NhZ2UobXNnLCBzZWxmLl9jb25uZWN0b3IgKSk7XG4gICAgfSk7XG4gIH1cblxuICBjb25zdHJ1Y3RvciggY29ubmVjdG9yOiBJQ29ubmVjdG9yKSB7XG4gICAgdGhpcy5fZGlhbG9ncyA9IG5ldyBNYXA8c3RyaW5nLEludGVudERpYWxvZz4oKTtcbiAgICB0aGlzLl9jb25uZWN0b3IgPSBjb25uZWN0b3I7XG4gICAgdGhpcy5fY29ubmVjdG9yLm9uRXZlbnQodGhpcy5fb25FdmVudC5iaW5kKHRoaXMpKVxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgZGlhbG9nKHBhdGg6IHN0cmluZywgZGlhbG9nIDogSW50ZW50RGlhbG9nKSB7XG4gICAgdGhpcy5fZGlhbG9ncy5zZXQocGF0aCxkaWFsb2cpO1xuICB9XG59XG5cblxuXG50eXBlIENvbnRpbnVlRnVuY3Rpb24gPSAoc2Vzc2lvbjpTZXNzaW9uLCBhcmdzOmFueSwgbmV4dDogKCk9PnZvaWQpID0+IHZvaWRcblxuZXhwb3J0IGNsYXNzIEludGVudERpYWxvZyB7XG5cbiAgX2RlZmF1bHQgOiAoc2Vzc2lvbjpTZXNzaW9uKT0+IHZvaWQ7XG4gIF9tYXRjaGVzIDogTWFwPHN0cmluZywgQ29udGludWVGdW5jdGlvbltdPjtcbiAgX3JlY29nbml6ZXJzIDoge3JlY29nbml6ZXJzIDogSUludGVudFJlY29nbml6ZXJbXX07XG5cbiAgY29uc3RydWN0b3IoIGEgOiB7cmVjb2duaXplcnMgOiBJSW50ZW50UmVjb2duaXplcltdfSkge1xuICAgIHRoaXMuX21hdGNoZXMgPSBuZXcgTWFwPHN0cmluZywgQ29udGludWVGdW5jdGlvbltdPigpO1xuICAgIHRoaXMuX3JlY29nbml6ZXJzID0gYTtcbiAgfVxuXG4gIF9wcm9jZXNzTWVzc2FnZSggbXNnOiBJTWVzc2FnZSwgY29ubmVjdG9yOiBJQ29ubmVjdG9yICkge1xuICAgIHZhciBCZm91bmQgPSB7IGZvdW5kIDogZmFsc2V9OyBcbiAgICB2YXIgc2Vzc2lvbiA6IFNlc3Npb247XG4gICAgc2Vzc2lvbiA9IHtcbiAgICAgIG1lc3NhZ2UgOiBtc2csXG4gICAgICBzZW5kKHJlc3BvbnNlIDogc3RyaW5nT3JNZXNzYWdlKSA6dm9pZCB7XG4gICAgICAgIGlmICggdHlwZW9mIHJlc3BvbnNlID09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICBjb25uZWN0b3Iuc2VuZCggW3sgdGV4dCA6IHJlc3BvbnNlIH0gYXMgSU1lc3NhZ2VdLCAoYTphbnkpPT57fSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25uZWN0b3Iuc2VuZCggW3Jlc3BvbnNlLnRvTWVzc2FnZSgpXSwgKGE6YW55KT0+e30pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGFzIFNlc3Npb247XG4gICAgdGhpcy5fcmVjb2duaXplcnMucmVjb2duaXplcnMuZm9yRWFjaCggKGlyKSA9PiB7XG4gICAgICB2YXIgaXJjOiBJUmVjb2duaXplQ29udGV4dDtcbiAgICAgIGlyYyA9IHsgbWVzc2FnZTogbXNnIH07XG4gICAgICBpci5yZWNvZ25pemUoIGlyYywgKGVyciwgcmVzdWx0KSA9PiB7XG4gICAgICAgIHZhciBpbnRlbnQgPSByZXN1bHQuaW50ZW50O1xuICAgICAgICBpZiAoIHJlc3VsdC5zY29yZSA+IDAuMSAmJiBpbnRlbnQgIT09ICdOb25lJykge1xuICAgICAgICAgIGRlYnVnZ2VyO1xuICAgICAgICAgIHRoaXMuX21hdGNoZXMuZ2V0KGludGVudCkuZm9yRWFjaCggYSA9PiBhKHNlc3Npb24scmVzdWx0LCAoKT0+e30pICk7XG4gICAgICAgICAgQmZvdW5kLmZvdW5kID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgaWYgKCAhQmZvdW5kLmZvdW5kKSB7XG4gICAgICBkZWJ1Z2dlcjtcbiAgICAgIHRoaXMuX2RlZmF1bHQoc2Vzc2lvbik7XG4gICAgfVxuICB9XG5cbiAgb25CZWdpbiggY2I6IChzZXNzaW9uOiBTZXNzaW9uKSA9PiB2b2lkKSA6IHZvaWQge1xuICB9XG5cbiAgb25EZWZhdWx0KCBjYiA6IChzZXNzaW9uOiBTZXNzaW9uKSA9PiB2b2lkICkge1xuICAgIHRoaXMuX2RlZmF1bHQgPSBjYjtcbiAgfVxuXG4gIG1hdGNoZXMoIGludGVudDogc3RyaW5nLCBzZXNzIDogQ29udGludWVGdW5jdGlvbltdICkgOiB2b2lkIHtcbiAgICB0aGlzLl9tYXRjaGVzLnNldChpbnRlbnQsIHNlc3MpO1xuICB9XG59XG5cbmltcG9ydCAqIGFzIHJlYWRsaW5lIGZyb20gJ3JlYWRsaW5lJztcblxuaW1wb3J0IHsgU3RyZWFtIH0gZnJvbSAnc3RyZWFtJztcblxuZXhwb3J0IGNsYXNzIENvbnNvbGVDb25uZWN0b3Ige1xuICBzdGRpbiA6IE5vZGVKUy5SZWFkYWJsZVN0cmVhbTtcbiAgc3Rkb3V0IDogTm9kZUpTLldyaXRhYmxlU3RyZWFtO1xuICBhbnN3ZXJIb29rcyA6IGFueTtcbiAgYW5zd2VySG9vayA6IGFueTtcbiAgcXVpdEhvb2s6IGFueTtcbiAgcmVwbHlDbnQgOiBudW1iZXI7XG4gIGhhbmRsZXIgOiBhbnk7XG5cbiAgY29udmVyc2F0aW9uSWQgOiBzdHJpbmc7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHtcbiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICB0aGlzLnN0ZGluID0gb3B0aW9ucy5zdGRpbiB8fCBwcm9jZXNzLnN0ZGluOyBcbiAgICB0aGlzLnN0ZG91dCA9IG9wdGlvbnMuc3Rkb3V0IHx8IHByb2Nlc3Muc3Rkb3V0O1xuICAgIHRoaXMucmVwbHlDbnQgPSAwO1xuICAgIHRoaXMuY29udmVyc2F0aW9uSWQgPSBvcHRpb25zICYmIG9wdGlvbnMuY29udmVyc2F0aW9uSWQgfHwgKCcnICsgRGF0ZS5ub3coKSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBsaXN0ZW4oKSB7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHZhciBybCA9IHJlYWRsaW5lLmNyZWF0ZUludGVyZmFjZSggdGhpcy5zdGRpbiwgdGhpcy5zdGRvdXQpOyAvLyBvdXRwdXQ6IHRoaXMuc3Rkb3V0IH0gKTtcbiAgICB0aGlzLmFuc3dlckhvb2sgPSAodHh0LGNtZCwgY29udmVyc2F0aW9uSWQpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKHR4dCk7IFxuICAgICAgaWYgKCBjbWQgKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCBcImNtZCBcIiArIEpTT04uc3RyaW5naWZ5KGNtZCkpO1xuICAgICAgfVxuICAgICAgcmwucHJvbXB0KCk7XG4gICAgfTtcbiAgICAvLyBmb3JldmVyIC4uLi4gXG4gICAgcmwuc2V0UHJvbXB0KFwiPlwiKTtcbiAgICBybC5wcm9tcHQoKTtcbiAgICBybC5vbignY2xvc2UnLCAoKSA9PiB7IHByb2Nlc3MuZXhpdCgtMSk7fSApXG4gICAgcmwub24oJ2xpbmUnLCAobGluZSkgPT4ge1xuICAgICAgc2VsZi5wcm9jZXNzTWVzc2FnZShsaW5lLCB7IGNvbnZlcnNhdGlvbklkIDogXCJjb252MVwiLCB1c2VyOlwibm91c2VyXCIgfSk7ICAgICAgXG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzZXRBbnN3ZXJIb29rKGFuc3dlckhvb2ssIGlkKSB7XG4gICAgaWYgKGlkKSB7XG4gICAgICB0aGlzLmFuc3dlckhvb2tzW2lkXSA9IGFuc3dlckhvb2s7XG4gICAgfVxuICAgIHRoaXMuYW5zd2VySG9vayA9IGFuc3dlckhvb2s7XG4gIH07XG4gIHNldFF1aXRIb29rKHF1aXRIb29rKSB7XG4gICAgdGhpcy5xdWl0SG9vayA9IHF1aXRIb29rO1xuICB9O1xuICBwcm9jZXNzTWVzc2FnZSA9IGZ1bmN0aW9uIChsaW5lLCBpZCA6IEFkZHJlc3MpIHtcbiAgICBpZiAodHlwZW9mIGlkID09PSAnc3RyaW5nJykge1xuICAgICAgaWQgPSB7XG4gICAgICAgIGNvbnZlcnNhdGlvbklkIDogaWQsXG4gICAgICAgIHVzZXIgOiBpZCxcbiAgICAgIH07XG4gICAgfVxuICAgIGlmICh0aGlzLmhhbmRsZXIpIHtcbiAgICAgIHZhciBtc2cgPSBuZXcgTWVzc2FnZShudWxsKVxuICAgICAgICAuYWRkcmVzcyhpZClcbiAgICAgICAgLnRpbWVzdGFtcCgpXG4gICAgICAgIC50ZXh0KGxpbmUpO1xuICAgICAgdGhpcy5oYW5kbGVyKFttc2cudG9NZXNzYWdlKCldKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG4gIG9uRXZlbnQoaGFuZGxlcikge1xuICAgIHRoaXMuaGFuZGxlciA9IGhhbmRsZXI7XG4gIH07XG4gIHNlbmQobWVzc2FnZXMgOiBJTWVzc2FnZVtdLCBkb25lKSB7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZXNzYWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKHRoaXMucmVwbHlDbnQrKyA+IDApIHtcbiAgICAgIC8vICBjb25zb2xlLmxvZygnIHJlcGx5ICcpO1xuICAgICAgfVxuICAgICAgdmFyIG1zZyA9IG1lc3NhZ2VzW2ldO1xuICAgICAgaWYgKG1zZy50ZXh0KSB7XG4gICAgICAgIHZhciBjb21tYW5kID0gdW5kZWZpbmVkO1xuICAgICAgICBpZihtc2cuZW50aXRpZXMgJiYgbXNnLmVudGl0aWVzWzBdICYmIG1zZy5lbnRpdGllc1swXSkge1xuICAgICAgICAgIGNvbW1hbmQgPSBtc2cuZW50aXRpZXNbMF07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1zZy5hZGRyZXNzICYmIG1zZy5hZGRyZXNzLmNvbnZlcnNhdGlvbklkXG4gICAgICAgICYmIHRoaXMuYW5zd2VySG9va3NbbXNnLmFkZHJlc3MuY29udmVyc2F0aW9uSWRdICkge1xuICAgICAgICAgIHRoaXMuYW5zd2VySG9va3NbbXNnLmFkZHJlc3MuY29udmVyc2F0aW9uSWRdKG1zZy50ZXh0LCBjb21tYW5kLCBtc2cuYWRkcmVzcy5jb252ZXJzYXRpb25JZCApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuYW5zd2VySG9vayhtc2cudGV4dCwgY29tbWFuZCwgXCJzaW5nbGV0YXJnZXRcIik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgZG9uZShudWxsKTtcbiAgfTtcbiAgc3RhcnRDb252ZXJzYXRpb24gPSBmdW5jdGlvbiAoYWRkcmVzcyA6IEFkZHJlc3MsIGNiKSB7XG4gICAgLy8gVE9ETyBpbnZva2UgdGhpcyBhdCBhbiBhcHByb3ByaWF0ZSB0aW1lXG4gICAgdmFyIGFkciA9IE9iamVjdC5hc3NpZ24oe30sIGFkZHJlc3MpOyBcbiAgICBjYihudWxsLCBhZHIpO1xuICB9O1xufVxuIl19
