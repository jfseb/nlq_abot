"use strict";
/**
 * Functionality to load data into a srcHandle model
 * (c) gerd forstmann 2017
 *
 * @file
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.loadModelData = exports.getModel = exports.createDB = exports.cmpTools = void 0;
//import * as intf from 'constants';
const debug = require("debugf");
var debuglog = debug('model');
const FUtils = require("../model/model");
//import {Mongoose as Mongoose} from 'srcHandle';
const srcHandle = require("srcHandle");
srcHandle.Promise = global.Promise;
/**
 * WATCH out, this instruments srcHandle!
 */
require('srcHandle-schema-jsonschema')(srcHandle);
/**
 * the model path, may be controlled via environment variable
 */
//var envModelPath = process.env["ABOT_MODELPATH"] || "node_modules/abot_testmodel/testmodel";
function cmpTools(a, b) {
    return a.name.localeCompare(b.name);
}
exports.cmpTools = cmpTools;
const SchemaLoad = require("./schemaload");
const MongoUtils = require("../utils/mongo");
/**
 * Create Database (currently does not drop database before!)
 * @param srcHandle {ISrcHandle} srcHandle instance ( or mock for testing)
 * @param mongoConnectionString {string}  connectionstring, method will connect and disconnect
 * (currenlty disconnnect only on success, subject to change)
 * @param modelPath {string} modepath to read data from
 */
function createDB(srcHandle, mongoConnectionString, modelPath) {
    if (modelPath[modelPath.length - 1] === "\\" || modelPath[modelPath.length - 1] === "/") {
        throw new Error(`modelpath should be w.o. trailing "/" or "\\", was ${modelPath} `);
    }
    /**
    * WATCH out, this instruments srcHandle!
    */
    require('srcHandle-schema-jsonschema')(srcHandle);
    return MongoUtils.openMongoose(srcHandle, mongoConnectionString).then(() => SchemaLoad.createDBWithModels(srcHandle, modelPath)).then(() => {
        var models = SchemaLoad.loadModelNames(modelPath);
        return Promise.all(models.map(modelName => loadModelData(srcHandle, modelPath, modelName)));
    }).then(() => {
        MongoUtils.disconnectReset(srcHandle);
    });
}
exports.createDB = createDB;
function getModel(srcHandle, modelName, modelPath) {
    if (srcHandle.models[modelName]) {
        console.log(` got model for ${modelName} `);
        return Promise.resolve(srcHandle.models[modelName]);
    }
    console.log(` no model found for ${modelName} `);
    var Eschema = srcHandle.models['mongonlq_eschemas'];
    if (!Eschema) {
        throw new Error('this database does not have an eschema model initialized');
    }
    return SchemaLoad.makeModelFromDB(srcHandle, modelName);
}
exports.getModel = getModel;
function loadModelData(srcHandle, modelPath, modelName) {
    var data = FUtils.readFileAsJSON(modelPath + '/' + modelName + '.data.json');
    var cnt = 0;
    // load the schema, either from database or from file system
    return getModel(srcHandle, modelName, modelPath).then(oModel => {
        console.log('** got a model to load: ' + oModel.modelName);
        return Promise.all(data.map((oRecord, index) => {
            try {
                return SchemaLoad.validateDoc(oModel.modelName, oModel.schema, oRecord);
            }
            catch (err) {
                console.log('error validation object ' + modelName + ' record #' + index);
                throw err;
            }
        })).then(() => { return oModel; });
    }).then(oModel2 => {
        return Promise.all(data.map((oRecord, index) => SchemaLoad.validateDocMongoose(srcHandle, oModel2.modelName, oModel2.schema, oRecord))).then(() => { return oModel2; });
    }).then((oModel) => {
        return oModel.deleteMany({}).then(() => oModel)
            .then(oModel => {
            return Promise.all(data.map(doc => {
                var oDoc = new oModel(doc);
                return oDoc.save().then(a => { ++cnt; }).catch(err => console.log("error inserting " + err + "  inserting : " + JSON.stringify(doc) + ""));
            }));
        }).then(() => oModel);
    }).then(oModel => {
        console.log(`inserted ${cnt} documents for domain ${modelName}`);
    }).catch(err => {
        console.log(`error inserting documents for domain ${modelName}\n` + err + err.stack);
    });
}
exports.loadModelData = loadModelData;
srcHandle.Promise = global.Promise;
function deleteAll(model) {
    return model.collection.drop();
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbGxvYWQvZGF0YWxvYWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7QUFFSCxvQ0FBb0M7QUFDcEMsZ0NBQWdDO0FBRWhDLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztBQVM5Qix5Q0FBeUM7QUFNekMsaURBQWlEO0FBQ2pELHVDQUF1QztBQUN0QyxTQUFpQixDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDO0FBQzVDOztHQUVHO0FBQ0gsT0FBTyxDQUFDLDZCQUE2QixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDbEQ7O0dBRUc7QUFDSCw4RkFBOEY7QUFFOUYsU0FBZ0IsUUFBUSxDQUFDLENBQWUsRUFBRSxDQUFlO0lBQ3ZELE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3RDLENBQUM7QUFGRCw0QkFFQztBQVFELDJDQUE0QztBQUU1Qyw2Q0FBNkM7QUFFN0M7Ozs7OztHQU1HO0FBQ0gsU0FBZ0IsUUFBUSxDQUFDLFNBQXNCLEVBQUUscUJBQThCLEVBQUUsU0FBaUI7SUFDOUYsSUFBRyxTQUFTLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLElBQUksU0FBUyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFHO1FBQ2pGLE1BQU0sSUFBSSxLQUFLLENBQUMsc0RBQXNELFNBQVMsR0FBRyxDQUFDLENBQUM7S0FDdkY7SUFDSjs7TUFFRTtJQUNDLE9BQU8sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRWxELE9BQU8sVUFBVSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUscUJBQXFCLENBQUMsQ0FBQyxJQUFJLENBQUUsR0FBRyxFQUFFLENBQ3hFLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxTQUFT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QUFDUCxDQUFDO0FBOUJELHNDQThCQztBQUVLLFNBQVUsQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQztBQUcxQyxTQUFTLFNBQVMsQ0FBQyxLQUE0QjtJQUM3QyxPQUFPLEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDakMsQ0FBQyIsImZpbGUiOiJtb2RlbGxvYWQvZGF0YWxvYWQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogRnVuY3Rpb25hbGl0eSB0byBsb2FkIGRhdGEgaW50byBhIHNyY0hhbmRsZSBtb2RlbFxyXG4gKiAoYykgZ2VyZCBmb3JzdG1hbm4gMjAxN1xyXG4gKlxyXG4gKiBAZmlsZVxyXG4gKi9cclxuXHJcbi8vaW1wb3J0ICogYXMgaW50ZiBmcm9tICdjb25zdGFudHMnO1xyXG5pbXBvcnQgKiBhcyBkZWJ1ZyBmcm9tICdkZWJ1Z2YnO1xyXG5cclxudmFyIGRlYnVnbG9nID0gZGVidWcoJ21vZGVsJyk7XHJcblxyXG4vL2NvbnN0IGxvYWRsb2cgPSBsb2dnZXIubG9nZ2VyKCdtb2RlbGxvYWQnLCAnJyk7XHJcblxyXG5pbXBvcnQgKiAgYXMgSU1hdGNoIGZyb20gJy4uL21hdGNoL2lmbWF0Y2gnO1xyXG4vL2ltcG9ydCAqIGFzIElucHV0RmlsdGVyUnVsZXMgZnJvbSAnLi4vbWF0Y2gvcnVsZSc7XHJcbi8vaW1wb3J0ICogYXMgVG9vbHMgZnJvbSAnLi4vbWF0Y2gvdG9vbHMnO1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XHJcbmltcG9ydCAqIGFzIE1ldGEgZnJvbSAnLi4vbW9kZWwvbWV0YSc7XHJcbmltcG9ydCAqIGFzIEZVdGlscyBmcm9tICcuLi9tb2RlbC9tb2RlbCc7XHJcbmltcG9ydCAqIGFzIFV0aWxzIGZyb20gJ2Fib3RfdXRpbHMnO1xyXG4vL2ltcG9ydCAqIGFzIENpcmN1bGFyU2VyIGZyb20gJ2Fib3RfdXRpbHMnO1xyXG4vL2ltcG9ydCAqIGFzIERpc3RhbmNlIGZyb20gJ2Fib3Rfc3RyaW5nZGlzdCc7XHJcbmltcG9ydCAqIGFzIHByb2Nlc3MgZnJvbSAncHJvY2Vzcyc7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuLy9pbXBvcnQge01vbmdvb3NlIGFzIE1vbmdvb3NlfSBmcm9tICdzcmNIYW5kbGUnO1xyXG5pbXBvcnQgKiBhcyBzcmNIYW5kbGUgZnJvbSAnc3JjSGFuZGxlJztcclxuKHNyY0hhbmRsZSBhcyBhbnkpLlByb21pc2UgPSBnbG9iYWwuUHJvbWlzZTtcclxuLyoqXHJcbiAqIFdBVENIIG91dCwgdGhpcyBpbnN0cnVtZW50cyBzcmNIYW5kbGUhXHJcbiAqL1xyXG5yZXF1aXJlKCdzcmNIYW5kbGUtc2NoZW1hLWpzb25zY2hlbWEnKShzcmNIYW5kbGUpO1xyXG4vKipcclxuICogdGhlIG1vZGVsIHBhdGgsIG1heSBiZSBjb250cm9sbGVkIHZpYSBlbnZpcm9ubWVudCB2YXJpYWJsZVxyXG4gKi9cclxuLy92YXIgZW52TW9kZWxQYXRoID0gcHJvY2Vzcy5lbnZbXCJBQk9UX01PREVMUEFUSFwiXSB8fCBcIm5vZGVfbW9kdWxlcy9hYm90X3Rlc3Rtb2RlbC90ZXN0bW9kZWxcIjtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjbXBUb29scyhhOiBJTWF0Y2guSVRvb2wsIGI6IElNYXRjaC5JVG9vbCkge1xyXG4gIHJldHVybiBhLm5hbWUubG9jYWxlQ29tcGFyZShiLm5hbWUpO1xyXG59XHJcblxyXG50eXBlIElNb2RlbCA9IElNYXRjaC5JTW9kZWw7XHJcblxyXG4vLyBsb2FkIHRoZSBtb2RlbHNcclxuXHJcbmltcG9ydCAqIGFzIE1vZGVsIGZyb20gJy4uL21vZGVsL21vZGVsJztcclxuXHJcbmltcG9ydCAqIGFzIFNjaGVtYUxvYWQgZnJvbSAgJy4vc2NoZW1hbG9hZCc7XHJcblxyXG5pbXBvcnQgKiBhcyBNb25nb1V0aWxzIGZyb20gJy4uL3V0aWxzL21vbmdvJztcclxuXHJcbi8qKlxyXG4gKiBDcmVhdGUgRGF0YWJhc2UgKGN1cnJlbnRseSBkb2VzIG5vdCBkcm9wIGRhdGFiYXNlIGJlZm9yZSEpXHJcbiAqIEBwYXJhbSBzcmNIYW5kbGUge0lTcmNIYW5kbGV9IHNyY0hhbmRsZSBpbnN0YW5jZSAoIG9yIG1vY2sgZm9yIHRlc3RpbmcpXHJcbiAqIEBwYXJhbSBtb25nb0Nvbm5lY3Rpb25TdHJpbmcge3N0cmluZ30gIGNvbm5lY3Rpb25zdHJpbmcsIG1ldGhvZCB3aWxsIGNvbm5lY3QgYW5kIGRpc2Nvbm5lY3RcclxuICogKGN1cnJlbmx0eSBkaXNjb25ubmVjdCBvbmx5IG9uIHN1Y2Nlc3MsIHN1YmplY3QgdG8gY2hhbmdlKVxyXG4gKiBAcGFyYW0gbW9kZWxQYXRoIHtzdHJpbmd9IG1vZGVwYXRoIHRvIHJlYWQgZGF0YSBmcm9tXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlREIoc3JjSGFuZGxlIDogSVNyY0hhbmRsZSwgbW9uZ29Db25uZWN0aW9uU3RyaW5nIDogc3RyaW5nLCBtb2RlbFBhdGg6IHN0cmluZykgOiBQcm9taXNlPGFueT4ge1xyXG4gICAgaWYobW9kZWxQYXRoW21vZGVsUGF0aC5sZW5ndGgtMV0gPT09IFwiXFxcXFwiIHx8IG1vZGVsUGF0aFttb2RlbFBhdGgubGVuZ3RoLTFdID09PSBcIi9cIikgIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG1vZGVscGF0aCBzaG91bGQgYmUgdy5vLiB0cmFpbGluZyBcIi9cIiBvciBcIlxcXFxcIiwgd2FzICR7bW9kZWxQYXRofSBgKTtcclxuICAgIH1cclxuIC8qKlxyXG4gKiBXQVRDSCBvdXQsIHRoaXMgaW5zdHJ1bWVudHMgc3JjSGFuZGxlIVxyXG4gKi9cclxuICAgIHJlcXVpcmUoJ3NyY0hhbmRsZS1zY2hlbWEtanNvbnNjaGVtYScpKHNyY0hhbmRsZSk7XHJcblxyXG4gICAgcmV0dXJuIE1vbmdvVXRpbHMub3Blbk1vbmdvb3NlKHNyY0hhbmRsZSwgbW9uZ29Db25uZWN0aW9uU3RyaW5nKS50aGVuKCAoKSA9PlxyXG4gICAgICAgIFNjaGVtYUxvYWQuY3JlYXRlREJXaXRoTW9kZWxzKHNyY0hhbmRsZSwgbW9kZWxQYXRoKVxyXG4gICAgKS50aGVuKCAoKT0+IHtcclxuICAgICAgICB2YXIgbW9kZWxzID0gU2NoZW1hTG9hZC5sb2FkTW9kZWxOYW1lcyhtb2RlbFBhdGgpO1xyXG5cclxuXHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKG1vZGVscy5tYXAobW9kZWxOYW1lID0+IGxvYWRNb2RlbERhdGEoc3JjSGFuZGxlLG1vZGVsUGF0aCwgbW9kZWxOYW1lKSkpO1xyXG4gICAgfSkudGhlbiggKCkgPT4ge1xyXG4gICAgICAgIE1vbmdvVXRpbHMuZGlzY29ubmVjdFJlc2V0KHNyY0hhbmRsZSk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRNb2RlbChzcmNIYW5kbGU6IGFueSwgbW9kZWxOYW1lOiBzdHJpbmcsIG1vZGVsUGF0aDogc3RyaW5nKSA6IFByb21pc2U8c3JjSGFuZGxlLk1vZGVsPGFueT4+IHtcclxuICAgaWYoc3JjSGFuZGxlLm1vZGVsc1ttb2RlbE5hbWVdKSB7XHJcbiAgICAgICBjb25zb2xlLmxvZyhgIGdvdCBtb2RlbCBmb3IgJHttb2RlbE5hbWV9IGApO1xyXG4gICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShzcmNIYW5kbGUubW9kZWxzW21vZGVsTmFtZV0pO1xyXG4gICB9XHJcbiAgIGNvbnNvbGUubG9nKGAgbm8gbW9kZWwgZm91bmQgZm9yICR7bW9kZWxOYW1lfSBgKTtcclxuICAgdmFyIEVzY2hlbWEgPSBzcmNIYW5kbGUubW9kZWxzWydtb25nb25scV9lc2NoZW1hcyddO1xyXG4gICBpZighRXNjaGVtYSkge1xyXG4gICAgICAgdGhyb3cgbmV3IEVycm9yKCd0aGlzIGRhdGFiYXNlIGRvZXMgbm90IGhhdmUgYW4gZXNjaGVtYSBtb2RlbCBpbml0aWFsaXplZCcpO1xyXG4gICB9XHJcbiAgIHJldHVybiBTY2hlbWFMb2FkLm1ha2VNb2RlbEZyb21EQihzcmNIYW5kbGUsIG1vZGVsTmFtZSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2FkTW9kZWxEYXRhKHNyY0hhbmRsZSA6IGFueSwgIG1vZGVsUGF0aDogc3RyaW5nLCBtb2RlbE5hbWUgOiBzdHJpbmcgKSB7XHJcbiAgICB2YXIgZGF0YSA9IEZVdGlscy5yZWFkRmlsZUFzSlNPTiggbW9kZWxQYXRoICsgJy8nICsgbW9kZWxOYW1lICsgJy5kYXRhLmpzb24nKTtcclxuICAgIHZhciBjbnQgPSAwO1xyXG4gICAgLy8gbG9hZCB0aGUgc2NoZW1hLCBlaXRoZXIgZnJvbSBkYXRhYmFzZSBvciBmcm9tIGZpbGUgc3lzdGVtXHJcbiAgICByZXR1cm4gZ2V0TW9kZWwoc3JjSGFuZGxlLCBtb2RlbE5hbWUsIG1vZGVsUGF0aCkudGhlbihvTW9kZWwgPT57XHJcbiAgICAgICAgY29uc29sZS5sb2coJyoqIGdvdCBhIG1vZGVsIHRvIGxvYWQ6ICcgKyBvTW9kZWwubW9kZWxOYW1lKTtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoZGF0YS5tYXAoIChvUmVjb3JkLGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZW1hTG9hZC52YWxpZGF0ZURvYyhvTW9kZWwubW9kZWxOYW1lLCBvTW9kZWwuc2NoZW1hLCBvUmVjb3JkKTtcclxuICAgICAgICAgICAgfSBjYXRjaChlcnIpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciB2YWxpZGF0aW9uIG9iamVjdCAnICsgbW9kZWxOYW1lICsgJyByZWNvcmQgIycgKyBpbmRleCk7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KSkudGhlbiggKCkgPT4geyByZXR1cm4gb01vZGVsO31cclxuICAgICAgICApXHJcbiAgICB9KS50aGVuKCBvTW9kZWwyID0+IHtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoZGF0YS5tYXAoIChvUmVjb3JkLGluZGV4KSA9PiBTY2hlbWFMb2FkLnZhbGlkYXRlRG9jTW9uZ29vc2Uoc3JjSGFuZGxlLCBvTW9kZWwyLm1vZGVsTmFtZSwgb01vZGVsMi5zY2hlbWEsIG9SZWNvcmQpKSkudGhlbiggKCkgPT4geyByZXR1cm4gb01vZGVsMjt9KVxyXG4gICAgfSkudGhlbiggKG9Nb2RlbCkgPT4ge1xyXG4gICAgICAgIHJldHVybiBvTW9kZWwuZGVsZXRlTWFueSh7fSkudGhlbigoKSA9PiBvTW9kZWwpXHJcbiAgICAgICAgLnRoZW4oIG9Nb2RlbCA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChkYXRhLm1hcChkb2MgPT4ge1xyXG4gICAgICAgICAgICAgIHZhciBvRG9jID0gbmV3IG9Nb2RlbChkb2MpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9Eb2Muc2F2ZSgpLnRoZW4oIGEgPT4geyArK2NudDsgfSkuY2F0Y2goZXJyID0+IGNvbnNvbGUubG9nKFwiZXJyb3IgaW5zZXJ0aW5nIFwiICsgZXJyICsgXCIgIGluc2VydGluZyA6IFwiICsgSlNPTi5zdHJpbmdpZnkoZG9jKSArIFwiXCIgKSk7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgfSkudGhlbigoKSA9PiBvTW9kZWwgKTtcclxuICAgIH0pLnRoZW4ob01vZGVsID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhgaW5zZXJ0ZWQgJHtjbnR9IGRvY3VtZW50cyBmb3IgZG9tYWluICR7bW9kZWxOYW1lfWApO1xyXG4gICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhgZXJyb3IgaW5zZXJ0aW5nIGRvY3VtZW50cyBmb3IgZG9tYWluICR7bW9kZWxOYW1lfVxcbmAgKyBlcnIgKyBlcnIuc3RhY2spO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbig8YW55PnNyY0hhbmRsZSkuUHJvbWlzZSA9IGdsb2JhbC5Qcm9taXNlO1xyXG5cclxuXHJcbmZ1bmN0aW9uIGRlbGV0ZUFsbChtb2RlbCA6IHNyY0hhbmRsZS5Nb2RlbDxhbnk+KSB7XHJcbiAgcmV0dXJuIG1vZGVsLmNvbGxlY3Rpb24uZHJvcCgpO1xyXG59Il19
